<!DOCTYPE html>
<html>
<head>
  <base target="_top" href="<?= ScriptApp.getService().getUrl() ?>">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ“ å—ä»˜å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ </title>
  <style>
    :root {
      --bg: #f6f8fb;
      --card: #ffffff;
      --primary: #2f6feb;
      --accent: #7c3aed;
      --text: #1f2937;
      --muted: #6b7280;
      --border: #e5e7eb;
      --success: #16a34a;
      --danger: #dc2626;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Apple Color Emoji, Noto Color Emoji, Arial, "Hiragino Kaku Gothic ProN", Meiryo, "æ¸¸ã‚´ã‚·ãƒƒã‚¯ä½“", YuGothic, sans-serif;
      background: linear-gradient(120deg, #eef2ff, #fdf2f8);
      color: var(--text);
    }
    .container { max-width: 1200px; margin: 0 auto; padding: 24px; }
    .header { background: var(--card); border-radius: 16px; padding: 20px 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.06); margin-bottom: 18px; display:flex; justify-content:space-between; align-items:center; gap:16px; }
    .title { font-size: 20px; font-weight: 700; }
    .actions { display:flex; gap:10px; align-items:center; }
    .btn { appearance: none; border: 0; border-radius: 10px; padding: 10px 14px; font-weight: 600; cursor: pointer; box-shadow: 0 6px 16px rgba(0,0,0,0.08); background: var(--card); color: var(--text); border: 1px solid var(--border); }
    .btn.primary { background: linear-gradient(135deg, var(--primary), var(--accent)); color: #fff; border: 0; }
    .btn.ghost { background: transparent; border: 1px solid var(--border); }
    .grid { display: grid; grid-template-columns: 1fr; gap: 14px; }
    @media (min-width: 900px) { .grid.cols-2 { grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
       grid-template-rows: auto auto;
        align-items: start; }}
    .card { background: var(--card); border-radius: 14px; padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.06); border: 1px solid var(--border); min-width: 0; overflow: hidden; }
    .card h2 { margin: 0 0 10px; font-size: 16px; color: #2563eb; }
    .field { margin-bottom: 10px; min-width: 0; }
    .label { display:block; font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    input[type="text"], input[type="date"], input[type="time"], textarea, select { width: 100%; max-width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 10px; background: #fafafa; font-size: 14px; box-sizing: border-box; }
    textarea { min-height: 80px; resize: vertical; }
    .row { display: grid; grid-template-columns: 1fr; gap: 10px; }
    @media (min-width: 640px) { .row.cols-2 { grid-template-columns: 1fr 1fr; } .row.cols-3 { grid-template-columns: 1fr 1fr 1fr; }}
    .chips { display:flex; flex-wrap: wrap; gap: 8px; }
    .vlist { display:flex; flex-direction: column; gap:8px; }
    .indent-1 { margin-left: 2ch; }
    .indent-2 { margin-left: 4ch; }
    .indent-3 { margin-left: 6ch; }
    .chip { display:inline-flex; align-items:center; gap:6px; border:1px solid var(--border); border-radius:999px; padding:6px 10px; background:#fff; box-shadow: inset 0 -1px 0 rgba(0,0,0,0.03); font-size: 12px; overflow-wrap: anywhere; }
    .muted { color: var(--muted); font-size: 12px; }
    .divider { height:1px; background: var(--border); margin: 10px 0; }
    .alert { padding: 10px 12px; border-radius: 10px; margin: 10px 0 0; font-size: 14px; border:1px solid var(--border); }
    .alert.success { background:#ecfdf5; color:#065f46; border-color:#a7f3d0; }
    .alert.error { background:#fef2f2; color:#991b1b; border-color:#fecaca; }
    .jsonbox { background:#0b1021; color:#c7d2fe; border-radius: 12px; padding: 12px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; overflow:auto; font-size: 12px; max-height:240px; }
  </style>
  <script>
    try { console.log('[reception_form] script start'); } catch(_e){}
    // --- safe helpers to avoid blank screen ---
    function esc(s){
      try { return String(s).replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); } catch(e){ return String(s); }
    }
    function getQueryParam(name){
      try {
        if (typeof URLSearchParams !== 'undefined') {
          const params = new URLSearchParams(location.search || '');
          return params.get(name);
        }
      } catch(_e) {}
      // Fallback manual parser
      try {
        const q = (location.search || '').replace(/^\?/,'');
        if (!q) return null;
        const map = {};
        q.split('&').forEach(pair => {
          if (!pair) return;
          const idx = pair.indexOf('=');
          const k = idx>=0 ? decodeURIComponent(pair.slice(0,idx)) : decodeURIComponent(pair);
          const v = idx>=0 ? decodeURIComponent(pair.slice(idx+1)) : '';
          if (!(k in map)) map[k] = v;
        });
        return Object.prototype.hasOwnProperty.call(map, name) ? map[name] : null;
      } catch(_e2){ return null; }
    }
    function showFatalError(msg){
      var root = document.getElementById('root');
      if (root) {
        root.innerHTML = '<div class="alert error">èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼: ' + esc(msg) + '</div>';
      }
    }
    const contactMethods = ['é›»è©±','ãƒ¡ãƒ¼ãƒ«','FAX','çª“å£æ¥åº','ãã®ä»–ï¼ˆå…·ä½“çš„ã«ï¼‰'];
    const wards = ['ä¸­å¤®åŒº','åŒ—åŒº','æ±åŒº','ç™½çŸ³åŒº','è±Šå¹³åŒº','å—åŒº','è¥¿åŒº','åšåˆ¥åŒº','æ‰‹ç¨²åŒº','æ¸…ç”°åŒº','å¸‚å¤–','ä¸æ˜'];
    const assignees = ['è‡ªåˆ†','ç”°ä¸­','ä½è—¤','éˆ´æœ¨','é«˜æ©‹'];
    const consultationTargets = ['A:ç”Ÿç‰©','B:ã‚¢ã‚»ã‚¹','C:ãã®ä»–'];
    // ä»•æ§˜æ›¸ã«å¾“ã£ãŸç›¸è«‡ç¨®é¡ã®éšå±¤æ§‹é€ 
    const consultationTypeOptions = {
      // å…±é€š3ç¨®ï¼ˆç¸¦ã«ä¸¦ã¹ã‚‹ï¼‰
      common: ['ä¸€èˆ¬è«–çš„ç›¸è«‡ï¼ˆæ³•ãƒ»åˆ¶åº¦å«ã‚€ï¼‰','å€‹åˆ¥æ¡ˆä»¶ç›¸è«‡','ãã®ä»–'],
      // A:ç”Ÿç‰©ã®æ™‚ã®ã¿ã®å­éšå±¤
      general: ['å€‹ä½“æ•°ç®¡ç†ãƒ»å‰Šæ¸›','ä¿è­·ï¼ˆå€‹ä½“æ•°å¢—åŠ å«ã‚€ï¼‰','å¤–æ¥ç¨®é–¢ä¿‚','ä½ã¿åˆ†ã‘','ãã®ä»–'],
      individual: ['ç”Ÿæ´»ç’°å¢ƒè¢«å®³ï¼ˆè©³ç´°é¸æŠè‚¢ã‚ã‚Šï¼‰','ç”Ÿæ…‹ç³»ã‹ãä¹±ï¼ˆè©³ç´°é¸æŠè‚¢ã‚ã‚Šï¼‰','é¤Œä»˜ã‘','å‚·ç—…é³¥ç£ï¼ˆè©³ç´°é¸æŠè‚¢ã‚ã‚Šï¼‰','ãã®ä»–'],
      // ç”Ÿæ´»ç’°å¢ƒè¢«å®³ã®ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒª
      environmentalDamage: ['å®¶å±‹ä¾µå…¥ãƒ»å®¶è²¡ç ´æ','æ”»æ’ƒãƒ»å¨åš‡ãƒ»ã¤ãã¾ã¨ã„','æ„ŸæŸ“ç—‡ãƒ»ãƒ•ãƒ³ç­‰æ±šæ','é¨’éŸ³','å®¶åº­èœåœ’è¢«å®³','å¿ƒç†çš„å«Œæ‚ª','ãã®ä»–'],
      // ç”Ÿæ…‹ç³»ã‹ãä¹±ã®ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒª  
      ecologicalDisturbance: ['é³¥ç£é–“æ„ŸæŸ“ç—‡','éå‰°ç¹æ®–','å¸Œå°‘ç¨®ã¸ã®å½±éŸ¿','ãã®ä»–']
    };
    const responseTypeOptions = {
      biological: ['å§”è¨—ã§ã®é§†é™¤å¯¾å¿œ','ä»–ã®æ©Ÿé–¢ç­‰ã‚’ç´¹ä»‹ãƒ»ä¾é ¼ï¼ˆè©³ç´°é¸æŠè‚¢ã‚ã‚Šï¼‰','è¡Œæ”¿æŒ‡å°ç­‰','æƒ…å ±æä¾›ãƒ»èª¬æ˜','ãã®ä»–'],
      other: ['ä»–ã®æ©Ÿé–¢ç­‰ã‚’ç´¹ä»‹ãƒ»ä¾é ¼ï¼ˆè©³ç´°é¸æŠè‚¢ã‚ã‚Šï¼‰','è¡Œæ”¿æŒ‡å°ç­‰','æƒ…å ±æä¾›ãƒ»èª¬æ˜','ãã®ä»–']
    };
    const otherOrganizationsOptions = {
      'ç´¹ä»‹ï¼ˆè©³ç´°é¸æŠè‚¢ã‚ã‚Šï¼‰': {
        'åŒºåœŸæœ¨ã‚»ãƒ³ã‚¿ãƒ¼': [],
        'åŒºå¥åº·ãƒ»å­ã©ã‚‚èª²': [],
        'ç„¡æ–™å¼è­·å£«ç›¸è«‡': [],
        'PCO': [],
        'ãã®ä»–ï¼ˆå…·ä½“çš„ã«ï¼‰': ['è‡ªç”±å…¥åŠ›']
      },
      'ä¾é ¼ï¼ˆè©³ç´°é¸æŠè‚¢ã‚ã‚Šï¼‰': {
        'åŒºåœŸæœ¨ã‚»ãƒ³ã‚¿ãƒ¼': [],
        'åŒºå¥åº·ãƒ»å­ã©ã‚‚èª²': [],
        'ãã®ä»–ï¼ˆå…·ä½“çš„ã«ï¼‰': ['è‡ªç”±å…¥åŠ›']
      }
    };
    const removalDetailOptions = ['ã‚­ãƒ„ãƒç½ è¨­ç½®','ã‚¢ãƒ©ã‚¤ã‚°ãƒç½ è¨­ç½®','å­ã‚¬ãƒ©ã‚¹æ•ç²','å‚·ç—…é³¥ç£æ•ç²','ãã®ä»–ï¼ˆå…·ä½“çš„ã«ï¼‰'];
    const biologicalCategories = {
      'å“ºä¹³é¡ï¼ˆè©³ç´°é¸æŠè‚¢ã‚ã‚Šï¼‰': ['ã‚­ã‚¿ã‚­ãƒ„ãƒ','ã‚¢ãƒ©ã‚¤ã‚°ãƒ','ãƒ’ã‚°ãƒ','ã‚¨ã‚¾ã‚·ã‚«','ãã®ä»–ï¼ˆå…·ä½“çš„ã«ï¼‰'],
      'é³¥é¡ï¼ˆè©³ç´°é¸æŠè‚¢ã‚ã‚Šï¼‰': ['ã‚«ãƒ©ã‚¹','ãƒãƒˆ','ã‚«ãƒ¢ãƒ¡','ã‚¹ã‚ºãƒ¡','ãã®ä»–ï¼ˆå…·ä½“çš„ã«ï¼‰'],
      'ç”²æ®»é¡ãƒ»æ˜†è™«é¡ï¼ˆè©³ç´°é¸æŠè‚¢ã‚ã‚Šï¼‰': ['ãƒ’ã‚¢ãƒª','ã‚¯ãƒ“ã‚¢ã‚«ãƒ„ãƒ¤ã‚«ãƒŸã‚­ãƒªãƒ ã‚·','ãƒ„ãƒ¤ãƒãƒ€ã‚´ãƒãƒ€ãƒ©ã‚«ãƒŸã‚­ãƒª','ã‚µãƒ“ã‚¤ãƒ­ã‚¯ãƒ¯ã‚«ãƒŸã‚­ãƒª','ã‚»ã‚¤ãƒ¨ã‚¦ã‚ªã‚ªãƒãƒ«ãƒãƒŠãƒãƒ','ã‚¦ãƒãƒ€ã‚¶ãƒªã‚¬ãƒ‹','ã‚¢ãƒ¡ãƒªã‚«ã‚¶ãƒªã‚¬ãƒ‹','ãã®ä»–ï¼ˆå…·ä½“çš„ã«ï¼‰'],
      'çˆ¬è™«é¡ãƒ»ä¸¡ç”Ÿé¡ãƒ»é­šé¡ï¼ˆè©³ç´°é¸æŠè‚¢ã‚ã‚Šï¼‰': ['ã‚¢ãƒ¡ãƒªã‚«ã‚¦ã‚·ã‚¬ã‚¨ãƒ«','ã‚¢ã‚ºãƒãƒ’ã‚­ã‚¬ã‚¨ãƒ«ï¼ˆå¤–æ¥ç”±æ¥ï¼‰','ã‚¢ã‚ºãƒãƒ’ã‚­ã‚¬ã‚¨ãƒ«','ãƒˆãƒã‚µãƒã‚¬ã‚¨ãƒ«','ãã®ä»–ï¼ˆå…·ä½“çš„ã«ï¼‰'],
      'æ¤ç‰©ãƒ»èŒé¡ï¼ˆè©³ç´°é¸æŠè‚¢ã‚ã‚Šï¼‰': ['ã‚ªã‚ªã‚­ãƒ³ã‚±ã‚¤ã‚®ã‚¯','ã‚ªã‚ªãƒãƒ³ã‚´ã‚¦ã‚½ã‚¦','ã‚¢ãƒ¡ãƒªã‚«ã‚ªãƒ‹ã‚¢ã‚¶ãƒŸ','ãƒã‚¤ã‚«ãƒ«ãƒãƒŠã‚¦ãƒ‰','ãã®ä»–ï¼ˆå…·ä½“çš„ã«ï¼‰'],
      'ç¨®ä¸æ˜': [],
      'ç”Ÿç‰©å¤šæ§˜æ€§å…¨èˆ¬': []
    };
    
    // å­è¦ç´ ãŒãªã„ã‚«ãƒ†ã‚´ãƒªã‚’åˆ¤å®šã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    function hasSubcategories(category) {
      return biologicalCategories[category] && biologicalCategories[category].length > 0;
    }

      let state = {
      id: null,
      meta: {
        receptionDate: new Date().toISOString().slice(0,10),
        receptionTime: '',
        assignee: 'è‡ªåˆ†',
        ward: '',
        siteAddress: '',
        contactMethod: '',
        otherContactMethod: '',
        contactSource: '',
        contactInfo: ''
      },
        consultation: {
          consultationTarget: '',
          // æ–°ã—ã„éšå±¤æ§‹é€ ã«å¯¾å¿œ
          consultationTypes: {
            common: [], // å…±é€š3ç¨®ã®é¸æŠçŠ¶æ…‹
            general: [], // ä¸€èˆ¬è«–çš„ç›¸è«‡ã®å­é …ç›®
          individual: [], // å€‹åˆ¥æ¡ˆä»¶ç›¸è«‡ã®å­é …ç›®
          environmentalDamage: [], // ç”Ÿæ´»ç’°å¢ƒè¢«å®³ã®ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒª
          ecologicalDisturbance: [], // ç”Ÿæ…‹ç³»ã‹ãä¹±ã®ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒª
          injuredWildlife: [] // å‚·ç—…é³¥ç£ã®è¤‡æ•°é¸æŠï¼ˆä¿è­·/é§†é™¤/ãã®ä»–ï¼‰
          },
        selectedCategories: [],
        biologicalSpecies: {},
        otherBiologyTexts: {},
        subcategories: [],
        details: ''
      },
      response: {
        responseTypes: [],
        otherOrganizations: {
          introduceSelected: false,
          requestSelected: false,
          introduce: [],
          request: [],
          introduceDetails: {},
          requestDetails: {}
        },
        otherOrganizationsOther: {
          introduce: '',
          request: ''
        },
        responseContent: '',
        removalDetailOtherText: '',
        followupItems: [ { needsFollowup:false, followupDate:'', followupTime:'', followupContent:'' } ],
        remarks: '',
        individualCaseTag: ''
      },
      _ui: { showJson: false, alert: null }
    };

    function setIn(path, value) {
      let cur = state;
      for (let i=0;i<path.length-1;i++) cur = cur[path[i]];
      cur[path[path.length-1]] = value;
      render();
    }

    // å…¥åŠ›ä¸­ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¸ãƒ£ãƒ³ãƒ—ã‚’é¿ã‘ã‚‹ãŸã‚ã®è»½é‡æ›´æ–°ï¼ˆå†æç”»ã—ãªã„ï¼‰
    function setInNoRender(path, value) {
      let cur = state;
      for (let i=0;i<path.length-1;i++) cur = cur[path[i]];
      cur[path[path.length-1]] = value;
    }

    function onToggleArray(path, value, checked) {
      let cur = state; for (let i=0;i<path.length;i++) cur = cur[path[i]];
      const set = new Set(cur);
      checked ? set.add(value) : set.delete(value);
      setIn(path, Array.from(set));
    }

    function onToggleNestedArray(path, value, checked) {
      // path = ['response','otherOrganizations','introduceDetails','åŒºåœŸæœ¨ã‚»ãƒ³ã‚¿ãƒ¼']
      let cur = state;
      for (let i=0; i<path.length-1; i++) {
        if (!cur[path[i]]) cur[path[i]] = {};
        cur = cur[path[i]];
      }
      const lastKey = path[path.length-1];
      if (!cur[lastKey]) cur[lastKey] = [];
      const set = new Set(cur[lastKey]);
      checked ? set.add(value) : set.delete(value);
      cur[lastKey] = Array.from(set);
      render();
    }

    function onBioToggle(cat, species, checked) {
      const map = { ...(state.consultation.biologicalSpecies||{}) };
      if (!map[cat]) map[cat] = {};
      
      if (species === 'ãã®ä»–ï¼ˆå…·ä½“çš„ã«ï¼‰' || species === 'ãã®ä»–') {
        // ãã®ä»–ã®å ´åˆã¯ã€ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã«é–¢ã‚ã‚‰ãšæ–‡å­—åˆ—å€¤ã§ç®¡ç†ï¼ˆå¾Œã§otherBiologyTextsã‹ã‚‰è¨­å®šï¼‰
        if (checked) {
          map[cat][species] = state.consultation.otherBiologyTexts?.[cat] || '';
          // otherBiologyTextsã‚‚åˆæœŸåŒ–
          if (!state.consultation.otherBiologyTexts) state.consultation.otherBiologyTexts = {};
          if (!state.consultation.otherBiologyTexts[cat]) state.consultation.otherBiologyTexts[cat] = '';
        } else {
          delete map[cat][species];
          // ãƒã‚§ãƒƒã‚¯è§£é™¤æ™‚ã¯otherBiologyTextsã‚‚å‰Šé™¤
          if (state.consultation.otherBiologyTexts && state.consultation.otherBiologyTexts[cat]) {
            delete state.consultation.otherBiologyTexts[cat];
          }
        }
      } else {
        // é€šå¸¸ã®ç¨®ã®å ´åˆã¯ãƒ•ãƒ©ã‚°å€¤1ã‚’ä½¿ç”¨
        if (checked) {
          map[cat][species] = 1;
        } else {
          delete map[cat][species];
        }
      }
      
      // ã‚«ãƒ†ã‚´ãƒªã«ä½•ã‚‚é¸æŠãŒãªã„å ´åˆã¯å‰Šé™¤
      if (Object.keys(map[cat]).length === 0) {
        delete map[cat];
      }
      
      setIn(['consultation','biologicalSpecies'], map);
    }

    function onConsultationTargetChange(value) {
      // ç›¸è«‡å¯¾è±¡å¤‰æ›´æ™‚ã«é–¢é€£ã™ã‚‹é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
      state.consultation.consultationTarget = value;
      state.consultation.consultationTypes = {
        common: [],
        general: [],
        individual: [],
        environmentalDamage: [],
        ecologicalDisturbance: [],
        injuredWildlife: []
      };
      state.consultation.selectedCategories = [];
      state.consultation.biologicalSpecies = {};
      state.consultation.otherBiologyTexts = {};
      state.consultation.subcategories = [];
      state.response.otherOrganizations = {
        introduceSelected: false,
        requestSelected: false,
        introduce: [],
        request: [],
        introduceDetails: {},
        requestDetails: {}
      };
      state.response.otherOrganizationsOther = {
        introduce: '',
        request: ''
      };
      render();
    }

    function addFollowupIfNeeded(idx) {
      const items = state.response.followupItems.slice();
      const it = items[idx];
      if (it && it.needsFollowup && it.followupDate && it.followupContent && items.length < 5 && !items[idx+1]) {
        items.push({ needsFollowup:false, followupDate:'', followupTime:'', followupContent:'' });
        // ç¢ºå®Ÿã«å†æç”»ã™ã‚‹ãŸã‚setInã‚’ä½¿ç”¨
        setIn(['response','followupItems'], items);
      }
    }

    function flattenPaths(obj, prefix=[]) {
      const out = [];
      const isObj = v => v && typeof v === 'object' && !Array.isArray(v);
      if (Array.isArray(obj)) {
        obj.forEach((v,i)=>{ out.push(...flattenPaths(v, [...prefix, String(i+1)])); });
      } else if (isObj(obj)) {
        Object.keys(obj).forEach(k=>{ out.push(...flattenPaths(obj[k], [...prefix, k])); });
      } else {
        out.push([prefix, obj]);
      }
      return out;
    }

    function buildPayload() {
      // æ¡ä»¶ã‚µãƒ‹ã‚¿ã‚¤ã‚ºï¼ˆreception_form.jsxã®ä»•æ§˜æº–æ‹ ã®ç°¡ç•¥ç‰ˆï¼‰
      const s = JSON.parse(JSON.stringify(state));
      const t = s.consultation;
      const r = s.response;
      const currentConsultationTypes = t.consultationTypes.common || [];
      if (t.consultationTarget !== 'A:ç”Ÿç‰©') {
        t.selectedCategories = []; t.biologicalSpecies = {}; t.otherBiologyTexts = {};
      } else {
        Object.keys(t.biologicalSpecies||{}).forEach(cat=>{ if(!t.selectedCategories.includes(cat)) delete t.biologicalSpecies[cat]; });
        Object.keys(t.otherBiologyTexts||{}).forEach(cat=>{
          const speciesObj = t.biologicalSpecies[cat]||{};
          const hasOther = ('ãã®ä»–' in speciesObj) || ('ãã®ä»–ï¼ˆå…·ä½“çš„ã«ï¼‰' in speciesObj);
          if(!t.selectedCategories.includes(cat) || !hasOther) delete t.otherBiologyTexts[cat];
        });
      }
      // æ–°ã—ã„éšå±¤æ§‹é€ ã«å¯¾å¿œã—ãŸæ¡ä»¶ãƒã‚§ãƒƒã‚¯
      const hasEnvironmentalDamage = currentConsultationTypes.includes('å€‹åˆ¥æ¡ˆä»¶ç›¸è«‡') && 
                                    t.consultationTypes.individual && 
                                    t.consultationTypes.individual.includes('ç”Ÿæ´»ç’°å¢ƒè¢«å®³ï¼ˆè©³ç´°é¸æŠè‚¢ã‚ã‚Šï¼‰');
      if (!hasEnvironmentalDamage && !r.responseTypes.includes('å§”è¨—ã§ã®é§†é™¤å¯¾å¿œ')) {
        t.subcategories = [];
      }
      if (!r.responseTypes.includes('å§”è¨—ã§ã®é§†é™¤å¯¾å¿œ') || !t.subcategories.includes('ãã®ä»–ï¼ˆå…·ä½“çš„ã«ï¼‰')) {
        r.removalDetailOtherText = '';
      }
      // ç›¸è«‡ç¨®åˆ¥ï¼ˆéšå±¤JSONï¼‰ã‚’ä»•æ§˜ã©ãŠã‚Šã«æ§‹ç¯‰
      const consultTypesNested = {};
      // ä¸€èˆ¬è«–çš„ç›¸è«‡ï¼ˆè¦ªãƒ•ãƒ©ã‚°ã‚’å¸¸ã«ä¿å­˜ï¼‰
      if (currentConsultationTypes.includes('ä¸€èˆ¬è«–çš„ç›¸è«‡ï¼ˆæ³•ãƒ»åˆ¶åº¦å«ã‚€ï¼‰')) {
        const gens = t.consultationTypes.general || [];
        consultTypesNested['ä¸€èˆ¬è«–çš„ç›¸è«‡'] = { 'ï¼ˆé¸æŠï¼‰': 1 };
        gens.forEach(name => { consultTypesNested['ä¸€èˆ¬è«–çš„ç›¸è«‡'][name] = 1; });
      }
      // å€‹åˆ¥æ¡ˆä»¶ç›¸è«‡ï¼ˆè¦ªãƒ•ãƒ©ã‚°ã‚’å¸¸ã«ä¿å­˜ï¼‰
      if (currentConsultationTypes.includes('å€‹åˆ¥æ¡ˆä»¶ç›¸è«‡')) {
        const indiv = t.consultationTypes.individual || [];
        consultTypesNested['å€‹åˆ¥æ¡ˆä»¶ç›¸è«‡'] = consultTypesNested['å€‹åˆ¥æ¡ˆä»¶ç›¸è«‡'] || { 'ï¼ˆé¸æŠï¼‰': 1 };
        // ç”Ÿæ´»ç’°å¢ƒè¢«å®³ï¼ˆè¦ªãƒ•ãƒ©ã‚°ã‚’å¸¸ã«ä¿å­˜ï¼‰
        if (indiv.includes('ç”Ÿæ´»ç’°å¢ƒè¢«å®³ï¼ˆè©³ç´°é¸æŠè‚¢ã‚ã‚Šï¼‰')) {
          const envs = t.consultationTypes.environmentalDamage || [];
          consultTypesNested['å€‹åˆ¥æ¡ˆä»¶ç›¸è«‡']['ç”Ÿæ´»ç’°å¢ƒè¢«å®³'] = { 'ï¼ˆé¸æŠï¼‰': 1 };
          envs.forEach(n => { consultTypesNested['å€‹åˆ¥æ¡ˆä»¶ç›¸è«‡']['ç”Ÿæ´»ç’°å¢ƒè¢«å®³'][n] = 1; });
        }
        // ç”Ÿæ…‹ç³»ã‹ãä¹±ï¼ˆè¦ªãƒ•ãƒ©ã‚°ã‚’å¸¸ã«ä¿å­˜ï¼‰
        if (indiv.includes('ç”Ÿæ…‹ç³»ã‹ãä¹±ï¼ˆè©³ç´°é¸æŠè‚¢ã‚ã‚Šï¼‰')) {
          const ecos = t.consultationTypes.ecologicalDisturbance || [];
          consultTypesNested['å€‹åˆ¥æ¡ˆä»¶ç›¸è«‡']['ç”Ÿæ…‹ç³»ã‹ãä¹±'] = { 'ï¼ˆé¸æŠï¼‰': 1 };
          ecos.forEach(n => { consultTypesNested['å€‹åˆ¥æ¡ˆä»¶ç›¸è«‡']['ç”Ÿæ…‹ç³»ã‹ãä¹±'][n] = 1; });
        }
        // å‚·ç—…é³¥ç£ï¼ˆè¦ªãƒ•ãƒ©ã‚°ï¼‹è¤‡æ•°é¸æŠã®å­ï¼‰
        if (indiv.includes('å‚·ç—…é³¥ç£ï¼ˆè©³ç´°é¸æŠè‚¢ã‚ã‚Šï¼‰')) {
          consultTypesNested['å€‹åˆ¥æ¡ˆä»¶ç›¸è«‡']['å‚·ç—…é³¥ç£'] = { 'ï¼ˆé¸æŠï¼‰': 1 };
          const iwList = t.consultationTypes.injuredWildlife || [];
          iwList.forEach(iw => {
            if (iw === 'ä¿è­·' || iw === 'é§†é™¤' || iw === 'ãã®ä»–') {
              consultTypesNested['å€‹åˆ¥æ¡ˆä»¶ç›¸è«‡']['å‚·ç—…é³¥ç£'][iw] = 1;
            }
          });
        }
        // è‘‰ï¼ˆé¤Œä»˜ã‘ãƒ»ãã®ä»–ï¼‰
        ['é¤Œä»˜ã‘','ãã®ä»–'].forEach(leaf => {
          if (indiv.includes(leaf)) consultTypesNested['å€‹åˆ¥æ¡ˆä»¶ç›¸è«‡'][leaf] = 1;
        });
      }
      // å…±é€šã®ã€Œãã®ä»–ã€ãŒã‚ã‚Œã°ãƒˆãƒƒãƒ—ã«ä¿å­˜ï¼ˆä»»æ„ï¼‰
      if (currentConsultationTypes.includes('ãã®ä»–')) {
        consultTypesNested['ãã®ä»–'] = 1;
      }

      // ã“ã“ã‹ã‚‰æ—¥æœ¬èªã‚­ãƒ¼ã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’æ§‹ç¯‰
      const sys = {
        'ID': s.id || null,
        'ä½œæˆæ—¥æ™‚': new Date().toISOString(),
        'æ›´æ–°æ—¥æ™‚': new Date().toISOString()
      };
      const meta = {
        'å—ä»˜æ—¥': s.meta.receptionDate || '',
        'å—ä»˜æ™‚åˆ»': s.meta.receptionTime || '',
        'æ‹…å½“è€…': s.meta.assignee || '',
        'ç—…æ£Ÿ': s.meta.ward || '',
        'ç¾å ´ä½æ‰€': s.meta.siteAddress || '',
        'é€£çµ¡æ–¹æ³•': s.meta.contactMethod || '',
        'ãã®ä»–é€£çµ¡æ–¹æ³•': s.meta.otherContactMethod || '',
        'å•ã„åˆã‚ã›å…ƒ': s.meta.contactSource || '',
        'å•ã„åˆã‚ã›å…ƒé€£çµ¡å…ˆ': s.meta.contactInfo || ''
      };
      const consult = {
        'ç›¸è«‡å¯¾è±¡': t.consultationTarget || '',
        'ç›¸è«‡ç¨®åˆ¥': consultTypesNested,
        'ç”Ÿç‰©ã‚«ãƒ†ã‚´ãƒª': t.selectedCategories || [],
        'ç”Ÿç‰©ç¨®': t.biologicalSpecies || {},
        'ç”Ÿç‰©ç¨®ãã®ä»–è¨˜è¿°': t.otherBiologyTexts || {},
        'è©³ç´°ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒª': t.subcategories || [],
        'è©³ç´°': t.details || ''
      };
      const resp = {
        'å¯¾å¿œç¨®åˆ¥': r.responseTypes || [],
        'ä»–ã®æ©Ÿé–¢ç­‰': {
          'ã‚’ç´¹ä»‹é¸æŠ': r.otherOrganizations.introduceSelected || false,
          'ã«å¯¾å¿œä¾é ¼é¸æŠ': r.otherOrganizations.requestSelected || false,
          'ã‚’ç´¹ä»‹': r.otherOrganizations.introduce || [],
          'ã«å¯¾å¿œä¾é ¼': r.otherOrganizations.request || [],
          'ã‚’ç´¹ä»‹è©³ç´°': r.otherOrganizations.introduceDetails || {},
          'ã«å¯¾å¿œä¾é ¼è©³ç´°': r.otherOrganizations.requestDetails || {}
        },
        'ä»–ã®æ©Ÿé–¢ç­‰ãã®ä»–': {
          'ã‚’ç´¹ä»‹': r.otherOrganizationsOther.introduce || '',
          'ã«å¯¾å¿œä¾é ¼': r.otherOrganizationsOther.request || ''
        },
        'å¯¾å¿œå†…å®¹': r.responseContent || '',
        'é§†é™¤å¯¾å¿œè©³ç´°ãã®ä»–': r.removalDetailOtherText || '',
        'è¿½åŠ å¯¾å¿œ': (r.followupItems || []).map(it => ({
          'è¦è¿½åŠ å¯¾å¿œ': !!it.needsFollowup,
          'å¯¾å¿œæ—¥': it.followupDate || '',
          'å¯¾å¿œæ™‚åˆ»': it.followupTime || '',
          'è¿½åŠ å¯¾å¿œå†…å®¹': it.followupContent || ''
        })),
        'å‚™è€ƒ': r.remarks || '',
        'å€‹åˆ¥æ¡ˆä»¶ã‚¿ã‚°': r.individualCaseTag || ''
      };
      return { 'ã‚·ã‚¹ãƒ†ãƒ ': sys, 'ãƒ¡ã‚¿': meta, 'ç›¸è«‡': consult, 'å¯¾å¿œ': resp };
    }

    function save() {
      try { console.log('[reception_form] save() called'); } catch(_e){}
      const payload = buildPayload();
      const show = (msg, type) => { state._ui.alert = { msg, type }; render(); };
      document.getElementById('saveBtn').disabled = true;
      google.script.run
        .withSuccessHandler(res => { 
          try { if (res && res.id != null) state.id = res.id; } catch(e){}
          show(res && res.message ? res.message : 'ä¿å­˜ã—ã¾ã—ãŸ', 'success'); 
          document.getElementById('saveBtn').disabled = false; 
        })
        .withFailureHandler(err => { console.error(err); show('ä¿å­˜ã«å¤±æ•—: ' + (err && err.message ? err.message : err), 'error'); document.getElementById('saveBtn').disabled = false; })
        .saveReceptionData(payload);
    }

    function render() {
      try { console.log('[reception_form] render: start'); } catch(_e){}
      const root = document.getElementById('root');
      // Preserve current scroll position to avoid jump-to-top on re-render
      const prevScrollY = (window && (window.scrollY || window.pageYOffset)) || (document.documentElement && document.documentElement.scrollTop) || 0;
      const t = state.consultation.consultationTarget;
      // åŸºæœ¬ã®ç›¸è«‡ç¨®é¡ã¯å¸¸ã«å…±é€š3ç¨®é¡ã®ã¿
      const consultTypes = consultationTypeOptions.common;
      const responseTypes = t==='A:ç”Ÿç‰©' ? responseTypeOptions.biological : responseTypeOptions.other;
      const renderConsultationTypes = state.consultation.consultationTypes.common || [];

      root.innerHTML = `
        <div class="header">
          <div class="title">ğŸ“ å—ä»˜å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ </div>
          <div class="actions">
            <button class="btn ghost" onclick="window.location.href='?';">â† ä¸€è¦§ã¸</button>
            <button id="saveBtn" class="btn primary" onclick="save()">ğŸ’¾ ä¿å­˜</button>
          </div>
        </div>

        
          <div class="card">
            <h2>å—ä»˜ãƒ¡ã‚¿æƒ…å ±</h2>
            <div class="row cols-3">
              <div class="field"><span class="label">å—ä»˜æ—¥</span><input type="date" value="${state.meta.receptionDate}" oninput="setIn(['meta','receptionDate'], this.value)"></div>
              <div class="field"><span class="label">å—ä»˜æ™‚åˆ»</span><input type="time" value="${state.meta.receptionTime}" oninput="setIn(['meta','receptionTime'], this.value)"></div>
              <div class="field"><span class="label">æ‹…å½“</span>
                <select onchange="setIn(['meta','assignee'], this.value)">${assignees.map(a=>`<option ${state.meta.assignee===a?'selected':''}>${a}</option>`).join('')}</select>
              </div>
            </div>
            <div class="row cols-2">
              <div class="field"><span class="label">å•ã„åˆã‚ã›æ–¹æ³•</span>
                <div class="chips">
                  ${contactMethods.map(m=>`<label class="chip"><input type="radio" name="contact" value="${m}" ${state.meta.contactMethod===m?'checked':''} onchange="setIn(['meta','contactMethod'], this.value)">${m}</label>`).join('')}
                </div>
                ${state.meta.contactMethod==='ãã®ä»–ï¼ˆå…·ä½“çš„ã«ï¼‰' ? `<input type="text" placeholder="ãã®ä»–ã®æ–¹æ³•" value="${state.meta.otherContactMethod||''}" oninput="setInNoRender(['meta','otherContactMethod'], this.value)">` : ''}
              </div>
              <div class="field"><span class="label">åŒº</span>
                <div class="chips">${wards.map(w=>`<label class="chip"><input type="radio" name="ward" value="${w}" ${state.meta.ward===w?'checked':''} onchange="setIn(['meta','ward'], this.value)">${w}</label>`).join('')}</div>
              </div>
            </div>
              <div class="row cols-2">
              <div class="field"><span class="label">å•ã„åˆã‚ã›å…ƒ</span><textarea oninput="setInNoRender(['meta','contactSource'], this.value)">${state.meta.contactSource||''}</textarea></div>
              <div class="field"><span class="label">å•ã„åˆã‚ã›å…ƒã¸ã®é€£çµ¡å…ˆ</span><textarea placeholder="é›»è©±ãƒ»ãƒ¡ãƒ¼ãƒ«ç­‰" oninput="setInNoRender(['meta','contactInfo'], this.value)">${state.meta.contactInfo||''}</textarea></div>
            </div>
            <div class="field"><span class="label">ç¾å ´ä½æ‰€ç­‰</span><textarea oninput="setInNoRender(['meta','siteAddress'], this.value)">${state.meta.siteAddress||''}</textarea></div>
          </div>

        <div class="grid cols-2">
          <div class="card">
            <h2>ç›¸è«‡ãƒ–ãƒ­ãƒƒã‚¯</h2>
            <div class="field"><span class="label">ç›¸è«‡å¯¾è±¡</span>
              <div class="chips">${consultationTargets.map(v=>`<label class="chip"><input type="radio" name="target" value="${v}" ${state.consultation.consultationTarget===v?'checked':''} onchange="onConsultationTargetChange(this.value); console.log('ğŸ¯ Target change:', this.value)">${v}</label>`).join('')}
              </div>
            </div>
            ${t==='A:ç”Ÿç‰©' ? `
              <div class="field"><span class="label">ç”Ÿç‰©ã‚«ãƒ†ã‚´ãƒªè©³ç´°ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</span>
                <div class="vlist">
                  ${Object.keys(biologicalCategories).map(cat=>`
                    <div>
                      <label class="chip"><input type="checkbox" value="${cat}" ${(state.consultation.selectedCategories||[]).includes(cat)?'checked':''} onchange="onToggleArray(['consultation','selectedCategories'], this.value, this.checked); console.log('ğŸ”§ Category toggle:', this.value, this.checked)">${cat}</label>
                      ${ (state.consultation.selectedCategories||[]).includes(cat) && hasSubcategories(cat) ? `
                        <div class="field indent-1"><span class="label">${cat} ã®ç”Ÿç‰©ã‚«ãƒ†ã‚´ãƒªè©³ç´°ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</span>
                          <div class="chips">${biologicalCategories[cat].map(sp=>`<label class="chip"><input type="checkbox" value="${sp}" ${Object.prototype.hasOwnProperty.call(state.consultation.biologicalSpecies[cat]||{}, sp) ? 'checked' : ''} onchange="onBioToggle('${cat}','${sp}', this.checked); console.log('ğŸ¾ Bio toggle:', '${cat}', '${sp}', this.checked)">${sp}</label>`).join('')}
                          </div>
                        </div>
                        ${(() => {
                          const speciesObj = state.consultation.biologicalSpecies[cat]||{};
                          const hasOther = ('ãã®ä»–ï¼ˆå…·ä½“çš„ã«ï¼‰' in speciesObj) || ('ãã®ä»–' in speciesObj);
                          return hasOther ? `<div class=\"field indent-1\"><span class=\"label\">${cat} ãã®ä»–ï¼ˆå…·ä½“çš„ã«ï¼‰</span><input type=\"text\" value=\"${(state.consultation.otherBiologyTexts||{})[cat]||''}\" oninput=\"(()=>{ const map={...(state.consultation.otherBiologyTexts||{})}; map['${cat}']=this.value; setInNoRender(['consultation','otherBiologyTexts'], map); console.log('ğŸ“ Other text input:', '${cat}', this.value); }).call(this)\"></div>` : '';
                        })()}
                      `: ''}
                    </div>
                  `).join('')}
                </div>
              </div>
            ` : ''}
            ${t ? `
            <div class="field"><span class="label">ç›¸è«‡ç¨®é¡</span>
              <div class="vlist">
                ${consultTypes.map(opt=>`
                  <div>
                    <label class="chip"><input type="checkbox" value="${opt}" ${renderConsultationTypes.includes(opt)?'checked':''} onchange="onToggleArray(['consultation','consultationTypes','common'], this.value, this.checked)">${opt}</label>
                    ${t==='A:ç”Ÿç‰©' && opt==='ä¸€èˆ¬è«–çš„ç›¸è«‡ï¼ˆæ³•ãƒ»åˆ¶åº¦å«ã‚€ï¼‰' && renderConsultationTypes.includes(opt) ? `
                      <div class="field indent-1"><span class="label">ä¸€èˆ¬è«–çš„ç›¸è«‡ è©³ç´°ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</span>
                        <div class="vlist">${consultationTypeOptions.general.map(child=>`<label class="chip"><input type="checkbox" value="${child}" ${(state.consultation.consultationTypes.general||[]).includes(child)?'checked':''} onchange="onToggleArray(['consultation','consultationTypes','general'], this.value, this.checked)">${child}</label>`).join('')}</div>
                      </div>
                    ` : ''}
${t==='A:ç”Ÿç‰©' && opt==='å€‹åˆ¥æ¡ˆä»¶ç›¸è«‡' && renderConsultationTypes.includes(opt) ? `
  <div class="field indent-1"><span class="label">å€‹åˆ¥æ¡ˆä»¶ç›¸è«‡ è©³ç´°ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</span>
    <div class="vlist">
      ${consultationTypeOptions.individual.map(child => {
        let childHtml = `<div><label class="chip"><input type="checkbox" value="${child}" ${(state.consultation.consultationTypes.individual||[]).includes(child)?'checked':''} onchange="onToggleArray(['consultation','consultationTypes','individual'], this.value, this.checked)">${child}</label>`;
        
        if (child === 'ç”Ÿæ´»ç’°å¢ƒè¢«å®³ï¼ˆè©³ç´°é¸æŠè‚¢ã‚ã‚Šï¼‰' && (state.consultation.consultationTypes.individual||[]).includes('ç”Ÿæ´»ç’°å¢ƒè¢«å®³ï¼ˆè©³ç´°é¸æŠè‚¢ã‚ã‚Šï¼‰')) {
          childHtml += `<div class="field indent-2"><span class="label">ç”Ÿæ´»ç’°å¢ƒè¢«å®³è©³ç´°ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</span><div class="chips">${consultationTypeOptions.environmentalDamage.map(sc=>`<label class="chip"><input type="checkbox" value="${sc}" ${(state.consultation.consultationTypes.environmentalDamage||[]).includes(sc)?'checked':''} onchange="onToggleArray(['consultation','consultationTypes','environmentalDamage'], this.value, this.checked)">${sc}</label>`).join('')}</div></div>`;
        }
        
        if (child === 'ç”Ÿæ…‹ç³»ã‹ãä¹±ï¼ˆè©³ç´°é¸æŠè‚¢ã‚ã‚Šï¼‰' && (state.consultation.consultationTypes.individual||[]).includes('ç”Ÿæ…‹ç³»ã‹ãä¹±ï¼ˆè©³ç´°é¸æŠè‚¢ã‚ã‚Šï¼‰')) {
          childHtml += `<div class="field indent-2"><span class="label">ç”Ÿæ…‹ç³»ã‹ãä¹±è©³ç´°ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</span><div class="chips">${consultationTypeOptions.ecologicalDisturbance.map(sc=>`<label class="chip"><input type="checkbox" value="${sc}" ${(state.consultation.consultationTypes.ecologicalDisturbance||[]).includes(sc)?'checked':''} onchange="onToggleArray(['consultation','consultationTypes','ecologicalDisturbance'], this.value, this.checked)">${sc}</label>`).join('')}</div></div>`;
        }
        
        if (child === 'å‚·ç—…é³¥ç£ï¼ˆè©³ç´°é¸æŠè‚¢ã‚ã‚Šï¼‰' && (state.consultation.consultationTypes.individual||[]).includes('å‚·ç—…é³¥ç£ï¼ˆè©³ç´°é¸æŠè‚¢ã‚ã‚Šï¼‰')) {
          childHtml += `<div class="field indent-2"><span class="label">å‚·ç—…é³¥ç£è©³ç´°ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</span><div class="chips"><label class="chip"><input type="checkbox" value="ä¿è­·" ${(state.consultation.consultationTypes.injuredWildlife||[]).includes('ä¿è­·')?'checked':''} onchange="onToggleArray(['consultation','consultationTypes','injuredWildlife'], this.value, this.checked)">ä¿è­·</label><label class="chip"><input type="checkbox" value="é§†é™¤" ${(state.consultation.consultationTypes.injuredWildlife||[]).includes('é§†é™¤')?'checked':''} onchange="onToggleArray(['consultation','consultationTypes','injuredWildlife'], this.value, this.checked)">é§†é™¤</label><label class="chip"><input type="checkbox" value="ãã®ä»–" ${(state.consultation.consultationTypes.injuredWildlife||[]).includes('ãã®ä»–')?'checked':''} onchange="onToggleArray(['consultation','consultationTypes','injuredWildlife'], this.value, this.checked)">ãã®ä»–</label></div></div>`;
        }
        
        return childHtml + '</div>';
      }).join('')}
    </div>
  </div>
` : ''}
                  </div>
                `).join('')}
              </div>
            </div>
            ` : ''}
            <div class="field"><span class="label">ç›¸è«‡è©³ç´°</span><textarea oninput="setInNoRender(['consultation','details'], this.value)">${state.consultation.details||''}</textarea>
            </div>
          </div>

          <div class="card" style="align-self: start;">
            <h2>è¨˜éŒ²ãƒ»å¯¾å¿œ</h2>
            <div class="field"><span class="label">å¯¾å¿œç¨®é¡ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</span>
              <div class="vlist">
                ${responseTypes.map(opt=>`
                  <div>
                    <label class="chip"><input type="checkbox" value="${opt}" ${(state.response.responseTypes||[]).includes(opt)?'checked':''} onchange="onToggleArray(['response','responseTypes'], this.value, this.checked)">${opt}</label>
                    ${opt==='ä»–ã®æ©Ÿé–¢ç­‰ã‚’ç´¹ä»‹ãƒ»ä¾é ¼ï¼ˆè©³ç´°é¸æŠè‚¢ã‚ã‚Šï¼‰' && (state.response.responseTypes||[]).includes('ä»–ã®æ©Ÿé–¢ç­‰ã‚’ç´¹ä»‹ãƒ»ä¾é ¼ï¼ˆè©³ç´°é¸æŠè‚¢ã‚ã‚Šï¼‰') ? `
                      <div class="field indent-1">
                        <label class="chip"><input type="checkbox" ${state.response.otherOrganizations.introduceSelected?'checked':''} onchange="setIn(['response','otherOrganizations','introduceSelected'], this.checked)">ç´¹ä»‹ï¼ˆè©³ç´°é¸æŠè‚¢ã‚ã‚Šï¼‰</label>
                        ${state.response.otherOrganizations.introduceSelected ? `
                          <div class="chips indent-2" style="margin-top: 8px;">${Object.keys(otherOrganizationsOptions['ç´¹ä»‹ï¼ˆè©³ç´°é¸æŠè‚¢ã‚ã‚Šï¼‰']).map(o=>`<label class="chip"><input type="checkbox" value="${o}" ${(state.response.otherOrganizations.introduce||[]).includes(o)?'checked':''} onchange="onToggleArray(['response','otherOrganizations','introduce'], this.value, this.checked)">${o}</label>`).join('')}</div>
                          ${Object.keys(otherOrganizationsOptions['ç´¹ä»‹ï¼ˆè©³ç´°é¸æŠè‚¢ã‚ã‚Šï¼‰']).filter(o=>(state.response.otherOrganizations.introduce||[]).includes(o) && otherOrganizationsOptions['ç´¹ä»‹ï¼ˆè©³ç´°é¸æŠè‚¢ã‚ã‚Šï¼‰'][o].length > 0).map(o=>`
                            <div class="field indent-2"><span class="label">${o} è©³ç´°</span>
                              <div class="chips">${otherOrganizationsOptions['ç´¹ä»‹ï¼ˆè©³ç´°é¸æŠè‚¢ã‚ã‚Šï¼‰'][o].map(sub=>`<label class="chip"><input type="checkbox" value="${sub}" ${((state.response.otherOrganizations.introduceDetails||{})[o]||[]).includes(sub)?'checked':''} onchange="onToggleNestedArray(['response','otherOrganizations','introduceDetails','${o}'], this.value, this.checked)">${sub}</label>`).join('')}</div>
                            </div>
                          `).join('')}
                          ${(state.response.otherOrganizations.introduce||[]).includes('ãã®ä»–ï¼ˆå…·ä½“çš„ã«ï¼‰') ? `
                            <div class="field indent-2"><span class="label">ãã®ä»–ï¼ˆå…·ä½“çš„ã«ï¼‰</span><input type="text" value="${state.response.otherOrganizationsOther.introduce||''}" oninput="setInNoRender(['response','otherOrganizationsOther','introduce'], this.value)"></div>
                          ` : ''}
                        ` : ''}
                      </div>
                      <div class="field indent-1">
                        <label class="chip"><input type="checkbox" ${state.response.otherOrganizations.requestSelected?'checked':''} onchange="setIn(['response','otherOrganizations','requestSelected'], this.checked)">ä¾é ¼ï¼ˆè©³ç´°é¸æŠè‚¢ã‚ã‚Šï¼‰</label>
                        ${state.response.otherOrganizations.requestSelected ? `
                          <div class="chips indent-2" style="margin-top: 8px;">${Object.keys(otherOrganizationsOptions['ä¾é ¼ï¼ˆè©³ç´°é¸æŠè‚¢ã‚ã‚Šï¼‰']).map(o=>`<label class="chip"><input type="checkbox" value="${o}" ${(state.response.otherOrganizations.request||[]).includes(o)?'checked':''} onchange="onToggleArray(['response','otherOrganizations','request'], this.value, this.checked)">${o}</label>`).join('')}</div>
                          ${Object.keys(otherOrganizationsOptions['ä¾é ¼ï¼ˆè©³ç´°é¸æŠè‚¢ã‚ã‚Šï¼‰']).filter(o=>(state.response.otherOrganizations.request||[]).includes(o) && otherOrganizationsOptions['ä¾é ¼ï¼ˆè©³ç´°é¸æŠè‚¢ã‚ã‚Šï¼‰'][o].length > 0).map(o=>`
                            <div class="field indent-2"><span class="label">${o} è©³ç´°</span>
                              <div class="chips">${otherOrganizationsOptions['ä¾é ¼ï¼ˆè©³ç´°é¸æŠè‚¢ã‚ã‚Šï¼‰'][o].map(sub=>`<label class="chip"><input type="checkbox" value="${sub}" ${((state.response.otherOrganizations.requestDetails||{})[o]||[]).includes(sub)?'checked':''} onchange="onToggleNestedArray(['response','otherOrganizations','requestDetails','${o}'], this.value, this.checked)">${sub}</label>`).join('')}</div>
                            </div>
                          `).join('')}
                          ${(state.response.otherOrganizations.request||[]).includes('ãã®ä»–ï¼ˆå…·ä½“çš„ã«ï¼‰') ? `
                            <div class="field indent-2"><span class="label">ãã®ä»–ï¼ˆå…·ä½“çš„ã«ï¼‰</span><input type="text" value="${state.response.otherOrganizationsOther.request||''}" oninput="setInNoRender(['response','otherOrganizationsOther','request'], this.value)"></div>
                          ` : ''}
                        ` : ''}
                      </div>
                    ` : opt==='å§”è¨—ã§ã®é§†é™¤å¯¾å¿œ' && (state.response.responseTypes||[]).includes('å§”è¨—ã§ã®é§†é™¤å¯¾å¿œ') ? `
                      <div class="field indent-1"><span class="label">é§†é™¤å¯¾å¿œè©³ç´°ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</span>
                        <div class="chips">${removalDetailOptions.map(o=>`<label class="chip"><input type="checkbox" value="${o}" ${(state.consultation.subcategories||[]).includes(o)?'checked':''} onchange="onToggleArray(['consultation','subcategories'], this.value, this.checked)">${o}</label>`).join('')}</div>
                      </div>
                      ${state.consultation.subcategories.includes('ãã®ä»–ï¼ˆå…·ä½“çš„ã«ï¼‰') ? `
                        <div class="field indent-2"><span class="label">é§†é™¤å¯¾å¿œè©³ç´° ãã®ä»–ï¼ˆå…·ä½“çš„ã«ï¼‰</span><input type="text" value="${state.response.removalDetailOtherText||''}" oninput="setInNoRender(['response','removalDetailOtherText'], this.value)"></div>
                      `: ''}
                    ` : ''}
                  </div>
                `).join('')}
              </div>
            </div>
            <div class="field"><span class="label">å¯¾å¿œå†…å®¹</span><textarea oninput="setInNoRender(['response','responseContent'], this.value)">${state.response.responseContent||''}</textarea></div>
            <div class="divider"></div>
            <div class="field"><span class="label">è¿½åŠ å¯¾å¿œ</span>
              ${state.response.followupItems.map((it,idx)=>`
                ${idx === 0 || (state.response.followupItems[idx-1] && state.response.followupItems[idx-1].needsFollowup && state.response.followupItems[idx-1].followupDate && state.response.followupItems[idx-1].followupContent) ? `
                  <label class="chip" style="margin-bottom:8px;"><input type="checkbox" ${it.needsFollowup?'checked':''} onchange="(()=>{ const arr=state.response.followupItems.slice(); arr[${idx}].needsFollowup=this.checked; setIn(['response','followupItems'], arr); addFollowupIfNeeded(${idx}); })()">${idx === 0 ? 'è¦è¿½åŠ å¯¾å¿œ' : `è¦è¿½åŠ å¯¾å¿œï¼ˆ${idx+1}å›ç›®ï¼‰`}</label>
                  ${it.needsFollowup ? `
                    <div class="row cols-3" style="margin-bottom:8px; align-items:end;">
                      <input type="date" value="${it.followupDate||''}" oninput="(()=>{ const arr=state.response.followupItems.slice(); arr[${idx}].followupDate=this.value; setInNoRender(['response','followupItems'], arr); addFollowupIfNeeded(${idx}); })()">
                      <input type="time" value="${it.followupTime||''}" oninput="(()=>{ const arr=state.response.followupItems.slice(); arr[${idx}].followupTime=this.value; setInNoRender(['response','followupItems'], arr); })()">
                    </div>
                    <input type="text" placeholder="è¿½åŠ å¯¾å¿œå†…å®¹" value="${it.followupContent||''}" oninput="(()=>{ const arr=state.response.followupItems.slice(); arr[${idx}].followupContent=this.value; setInNoRender(['response','followupItems'], arr); addFollowupIfNeeded(${idx}); })()">
                  ` : ''}
                ` : ''}
              `).join('')}
            </div>
            <div class="row cols-2">
              <div class="field"><span class="label">å€‹åˆ¥æ¡ˆä»¶ã‚¿ã‚°</span><input type="text" value="${state.response.individualCaseTag||''}" oninput="setInNoRender(['response','individualCaseTag'], this.value)"></div>
              <div class="field"><span class="label">å‚™è€ƒ</span><input type="text" value="${state.response.remarks||''}" oninput="setInNoRender(['response','remarks'], this.value)"></div>
            </div>
          </div>

          <div class="card">
            <h2>JSONãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
            <div class="muted">ä¿å­˜æ™‚ã«å¤šæ®µãƒ˜ãƒƒãƒ€ãƒ¼ã¸ãƒãƒƒãƒ”ãƒ³ã‚°ã•ã‚Œã¾ã™</div>
            <div class="jsonbox">${(() => {
              try { return JSON.stringify(buildPayload(), null, 2).replace(/</g,'&lt;'); } catch(e) { return 'ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆã‚¨ãƒ©ãƒ¼: '+e.message; }
            })()}</div>
            ${state._ui.alert ? `<div class="alert ${state._ui.alert.type==='success'?'success':'error'}">${state._ui.alert.msg}</div>` : ''}
          </div>

          <div class="card">
            <h2>ğŸ“„ CSV to JSON ãƒ•ã‚©ãƒ¼ãƒ å®šç¾©å¤‰æ›</h2>
            <div class="muted">CSVå½¢å¼ã®ãƒ•ã‚©ãƒ¼ãƒ å®šç¾©ã‚’JSONã«å¤‰æ›ã—ã¾ã™ï¼ˆä»•æ§˜æ›¸ v1.0æº–æ‹ ï¼‰</div>
            <div class="field">
              <span class="label">CSVãƒ•ã‚¡ã‚¤ãƒ«</span>
              <input type="file" id="csvFile" accept=".csv,text/csv" onchange="onCSVFileChange(this)">
            </div>
            <div class="field">
              <span class="label">CSVãƒ†ã‚­ã‚¹ãƒˆç›´æ¥å…¥åŠ›</span>
              <textarea id="csvInput" placeholder="L1,L2,L3,L4,L5,L6,L7,L8,L9&#10;Block_B1,,,,,,,,&#10;X/display:æº€å¹´é½¢,,,,,,,," rows="6" oninput="onCSVTextChange(this.value)"></textarea>
            </div>
            <div class="actions" style="margin-top: 10px; display: flex; gap: 10px;">
              <button class="btn primary" onclick="convertCSVToJSON()">ğŸ”„ JSONå¤‰æ›</button>
              <button class="btn ghost" onclick="downloadJSON()" id="downloadBtn" disabled>ğŸ’¾ JSONä¿å­˜</button>
              <button class="btn ghost" onclick="clearCSVConverter()">ğŸ—‘ï¸ ã‚¯ãƒªã‚¢</button>
            </div>
            <div id="csvConversionResult" style="margin-top: 10px;"></div>
          </div>
        </div>
      `;
      // Restore scroll position
      try {
        if (typeof window !== 'undefined' && window.scrollTo) {
          window.scrollTo(0, prevScrollY);
        } else if (document && document.documentElement) {
          document.documentElement.scrollTop = prevScrollY;
        }
      } catch(_e){}
      try { console.log('[reception_form] render: end'); } catch(_e){}
    }
    // getQueryParam is defined above with safe fallback

    function loadIfEditing(){
      try { console.log('[reception_form] loadIfEditing: start'); } catch(_e){}
      const id = getQueryParam('id');
      if (!id) { render(); return; }
      try { console.log('[reception_form] loadIfEditing: id=', id); } catch(_e){}
      google.script.run
        .withSuccessHandler(obj => {
          try {
            // obj = { ã‚·ã‚¹ãƒ†ãƒ :{ID,ä½œæˆæ—¥æ™‚,æ›´æ–°æ—¥æ™‚}, ãƒ¡ã‚¿:{...}, ç›¸è«‡:{...}, å¯¾å¿œ:{...} }
            state.id = (obj && obj.ã‚·ã‚¹ãƒ†ãƒ  && obj.ã‚·ã‚¹ãƒ†ãƒ .ID) || null;
            const m = (obj && obj.ãƒ¡ã‚¿) || {};
            const q = (obj && obj.ç›¸è«‡) || {};
            const a = (obj && obj.å¯¾å¿œ) || {};
            state.meta = Object.assign({}, state.meta, {
              receptionDate: m['å—ä»˜æ—¥'] != null ? m['å—ä»˜æ—¥'] : state.meta.receptionDate,
              receptionTime: m['å—ä»˜æ™‚åˆ»'] != null ? m['å—ä»˜æ™‚åˆ»'] : state.meta.receptionTime,
              assignee: m['æ‹…å½“è€…'] != null ? m['æ‹…å½“è€…'] : state.meta.assignee,
              ward: m['ç—…æ£Ÿ'] != null ? m['ç—…æ£Ÿ'] : state.meta.ward,
              siteAddress: m['ç¾å ´ä½æ‰€'] != null ? m['ç¾å ´ä½æ‰€'] : state.meta.siteAddress,
              contactMethod: m['é€£çµ¡æ–¹æ³•'] != null ? m['é€£çµ¡æ–¹æ³•'] : state.meta.contactMethod,
              otherContactMethod: m['ãã®ä»–é€£çµ¡æ–¹æ³•'] != null ? m['ãã®ä»–é€£çµ¡æ–¹æ³•'] : state.meta.otherContactMethod,
              contactSource: m['å•ã„åˆã‚ã›å…ƒ'] != null ? m['å•ã„åˆã‚ã›å…ƒ'] : state.meta.contactSource,
              contactInfo: m['å•ã„åˆã‚ã›å…ƒé€£çµ¡å…ˆ'] != null ? m['å•ã„åˆã‚ã›å…ƒé€£çµ¡å…ˆ'] : state.meta.contactInfo
            });
            // ç›¸è«‡ç¨®åˆ¥ï¼ˆéšå±¤JSONï¼‰ã‹ã‚‰UIçŠ¶æ…‹ã‚’å¾©å…ƒ
            const cjson = q['ç›¸è«‡ç¨®åˆ¥'] || {};
            const hasGeneral = !!cjson['ä¸€èˆ¬è«–çš„ç›¸è«‡'];
            const hasIndividual = !!cjson['å€‹åˆ¥æ¡ˆä»¶ç›¸è«‡'];
            const common = [];
            if (hasGeneral) common.push('ä¸€èˆ¬è«–çš„ç›¸è«‡ï¼ˆæ³•ãƒ»åˆ¶åº¦å«ã‚€ï¼‰');
            if (hasIndividual) common.push('å€‹åˆ¥æ¡ˆä»¶ç›¸è«‡');
            // ãƒˆãƒƒãƒ—ã®ã€Œãã®ä»–ã€
            if (cjson['ãã®ä»–'] === 1) common.push('ãã®ä»–');
            const restored = {
              common: common,
              general: hasGeneral ? Object.keys(cjson['ä¸€èˆ¬è«–çš„ç›¸è«‡']||{}).filter(k=>k!=='ï¼ˆé¸æŠï¼‰') : [],
              individual: [],
              environmentalDamage: [],
              ecologicalDisturbance: [],
              injuredWildlife: []
            };
            if (hasIndividual) {
              const ind = cjson['å€‹åˆ¥æ¡ˆä»¶ç›¸è«‡'] || {};
              // è‘‰
              ['é¤Œä»˜ã‘','ãã®ä»–'].forEach(leaf => { if (ind[leaf] === 1) restored.individual.push(leaf); });
              // ç”Ÿæ´»ç’°å¢ƒè¢«å®³
              if (ind['ç”Ÿæ´»ç’°å¢ƒè¢«å®³']) {
                restored.individual.push('ç”Ÿæ´»ç’°å¢ƒè¢«å®³ï¼ˆè©³ç´°é¸æŠè‚¢ã‚ã‚Šï¼‰');
                if (typeof ind['ç”Ÿæ´»ç’°å¢ƒè¢«å®³'] === 'object') restored.environmentalDamage = Object.keys(ind['ç”Ÿæ´»ç’°å¢ƒè¢«å®³']).filter(k=>k!=='ï¼ˆé¸æŠï¼‰');
              }
              // ç”Ÿæ…‹ç³»ã‹ãä¹±
              if (ind['ç”Ÿæ…‹ç³»ã‹ãä¹±']) {
                restored.individual.push('ç”Ÿæ…‹ç³»ã‹ãä¹±ï¼ˆè©³ç´°é¸æŠè‚¢ã‚ã‚Šï¼‰');
                if (typeof ind['ç”Ÿæ…‹ç³»ã‹ãä¹±'] === 'object') restored.ecologicalDisturbance = Object.keys(ind['ç”Ÿæ…‹ç³»ã‹ãä¹±']).filter(k=>k!=='ï¼ˆé¸æŠï¼‰');
              }
              // å‚·ç—…é³¥ç£
              if (ind['å‚·ç—…é³¥ç£']) {
                restored.individual.push('å‚·ç—…é³¥ç£ï¼ˆè©³ç´°é¸æŠè‚¢ã‚ã‚Šï¼‰');
                if (typeof ind['å‚·ç—…é³¥ç£'] === 'object') {
                  const keys = Object.keys(ind['å‚·ç—…é³¥ç£']).filter(k=>k!=='ï¼ˆé¸æŠï¼‰' && ind['å‚·ç—…é³¥ç£'][k] === 1);
                  restored.injuredWildlife = keys;
                }
              }
            }
            const target = q['ç›¸è«‡å¯¾è±¡'] || state.consultation.consultationTarget;
            state.consultation = Object.assign({}, state.consultation, {
              consultationTarget: target,
              consultationTypes: restored,
              selectedCategories: q['ç”Ÿç‰©ã‚«ãƒ†ã‚´ãƒª'] != null ? q['ç”Ÿç‰©ã‚«ãƒ†ã‚´ãƒª'] : state.consultation.selectedCategories,
              biologicalSpecies: q['ç”Ÿç‰©ç¨®'] != null ? q['ç”Ÿç‰©ç¨®'] : state.consultation.biologicalSpecies,
              otherBiologyTexts: q['ç”Ÿç‰©ç¨®ãã®ä»–è¨˜è¿°'] != null ? q['ç”Ÿç‰©ç¨®ãã®ä»–è¨˜è¿°'] : state.consultation.otherBiologyTexts,
              subcategories: q['è©³ç´°ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒª'] != null ? q['è©³ç´°ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒª'] : state.consultation.subcategories,
              details: q['è©³ç´°'] != null ? q['è©³ç´°'] : state.consultation.details
            });
            const fu = Array.isArray(a['è¿½åŠ å¯¾å¿œ']) ? a['è¿½åŠ å¯¾å¿œ'].map(it => ({
              needsFollowup: !!it['è¦è¿½åŠ å¯¾å¿œ'],
              followupDate: it['å¯¾å¿œæ—¥'] || '',
              followupTime: it['å¯¾å¿œæ™‚åˆ»'] || '',
              followupContent: it['è¿½åŠ å¯¾å¿œå†…å®¹'] || ''
            })) : state.response.followupItems;
            // Handle response types and hierarchical other organizations data
            const responseData = a['å¯¾å¿œç¨®åˆ¥'] != null ? a['å¯¾å¿œç¨®åˆ¥'] : state.response.responseTypes;
            const otherOrganizationsRawData = a['ä»–ã®æ©Ÿé–¢ç­‰'] != null ? a['ä»–ã®æ©Ÿé–¢ç­‰'] : {};
            const otherOrganizationsData = {
              introduceSelected: otherOrganizationsRawData['ã‚’ç´¹ä»‹é¸æŠ'] || false,
              requestSelected: otherOrganizationsRawData['ã«å¯¾å¿œä¾é ¼é¸æŠ'] || false,
              introduce: otherOrganizationsRawData['ã‚’ç´¹ä»‹'] || [],
              request: otherOrganizationsRawData['ã«å¯¾å¿œä¾é ¼'] || [],
              introduceDetails: otherOrganizationsRawData['ã‚’ç´¹ä»‹è©³ç´°'] || {},
              requestDetails: otherOrganizationsRawData['ã«å¯¾å¿œä¾é ¼è©³ç´°'] || {}
            };
            
            state.response = Object.assign({}, state.response, {
              responseTypes: responseData,
              otherOrganizations: otherOrganizationsData,
              responseContent: a['å¯¾å¿œå†…å®¹'] != null ? a['å¯¾å¿œå†…å®¹'] : state.response.responseContent,
              removalDetailOtherText: a['é§†é™¤å¯¾å¿œè©³ç´°ãã®ä»–'] != null ? a['é§†é™¤å¯¾å¿œè©³ç´°ãã®ä»–'] : state.response.removalDetailOtherText,
              followupItems: fu,
              remarks: a['å‚™è€ƒ'] != null ? a['å‚™è€ƒ'] : state.response.remarks,
              individualCaseTag: a['å€‹åˆ¥æ¡ˆä»¶ã‚¿ã‚°'] != null ? a['å€‹åˆ¥æ¡ˆä»¶ã‚¿ã‚°'] : state.response.individualCaseTag
            });
          } catch(e) { console.error('map error', e); }
          try { console.log('[reception_form] loadIfEditing: success, calling render'); } catch(_e){}
          render();
        })
        .withFailureHandler(err => { try{ console.error('load failed', err); }catch(_e){}; render(); })
        .getReceptionById(id);
    }

    // Global error surfaces so page is never blank
    window.addEventListener('error', function(e){ try{ showFatalError(e && e.message ? e.message : 'æœªçŸ¥ã®ã‚¨ãƒ©ãƒ¼'); }catch(_){} });
    window.addEventListener('unhandledrejection', function(e){ try{ var m=(e&&e.reason&&e.reason.message)||e.reason||'Promise ã‚¨ãƒ©ãƒ¼'; showFatalError(m); }catch(_){} });
    document.addEventListener('DOMContentLoaded', function(){ try{ console.log('[reception_form] DOMContentLoaded'); loadIfEditing(); } catch(err){ showFatalError(err && err.message ? err.message : err); } });
    // Fallback: also trigger on window.onload
    window.addEventListener('load', function(){ try{ console.log('[reception_form] window.load'); var r=document.getElementById('root'); if (r && !r.firstChild) render(); } catch(err){ showFatalError(err && err.message ? err.message : err); } });
    // Fallback timer: ensure something renders even if events are blocked
    setTimeout(function(){ try{ console.log('[reception_form] fallback timer firing'); if (document.getElementById('root') && !document.getElementById('root').children.length) render(); } catch(err){ showFatalError(err && err.message ? err.message : err); } }, 2000);

    // CSV to JSON Converter Functions
    let csvConverterState = {
      csvContent: '',
      jsonResult: null,
      errors: []
    };

    function onCSVFileChange(input) {
      const file = input.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const content = e.target.result;
        csvConverterState.csvContent = content;
        document.getElementById('csvInput').value = content;
        console.log('CSV file loaded:', content.substring(0, 100));
      };
      reader.readAsText(file, 'UTF-8');
    }

    function onCSVTextChange(value) {
      csvConverterState.csvContent = value;
      console.log('CSV text changed:', value.substring(0, 100));
    }

    function convertCSVToJSON() {
      if (!csvConverterState.csvContent.trim()) {
        showCSVResult('CSVãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
      }

      const resultDiv = document.getElementById('csvConversionResult');
      resultDiv.innerHTML = '<div class="muted">å¤‰æ›ä¸­...</div>';

      google.script.run
        .withSuccessHandler(function(result) {
          console.log('CSV conversion result:', result);
          if (result.success) {
            csvConverterState.jsonResult = result.data;
            csvConverterState.errors = [];
            showCSVResult('âœ… å¤‰æ›æˆåŠŸï¼', 'success');
            document.getElementById('downloadBtn').disabled = false;
            
            // JSONçµæœã‚’è¡¨ç¤º
            const jsonBox = `<div class="jsonbox" style="margin-top: 10px; max-height: 300px;">${JSON.stringify(result.data, null, 2).replace(/</g,'&lt;')}</div>`;
            document.getElementById('csvConversionResult').innerHTML += jsonBox;
          } else {
            csvConverterState.errors = [result.error];
            showCSVResult('âŒ å¤‰æ›å¤±æ•—: ' + result.error, 'error');
            document.getElementById('downloadBtn').disabled = true;
          }
        })
        .withFailureHandler(function(error) {
          console.error('CSV conversion error:', error);
          showCSVResult('âŒ å¤‰æ›ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
          document.getElementById('downloadBtn').disabled = true;
        })
        .parseCSVFormDefinition(csvConverterState.csvContent);
    }

    function showCSVResult(message, type) {
      const resultDiv = document.getElementById('csvConversionResult');
      const alertClass = type === 'success' ? 'success' : 'error';
      resultDiv.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
    }

    function downloadJSON() {
      if (!csvConverterState.jsonResult) {
        showCSVResult('å¤‰æ›çµæœãŒã‚ã‚Šã¾ã›ã‚“', 'error');
        return;
      }

      const jsonString = JSON.stringify(csvConverterState.jsonResult, null, 2);
      const blob = new Blob([jsonString], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = 'form-definition-' + new Date().toISOString().slice(0, 19).replace(/:/g, '-') + '.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      showCSVResult('JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ', 'success');
    }

    function clearCSVConverter() {
      csvConverterState = {
        csvContent: '',
        jsonResult: null,
        errors: []
      };
      document.getElementById('csvFile').value = '';
      document.getElementById('csvInput').value = '';
      document.getElementById('csvConversionResult').innerHTML = '';
      document.getElementById('downloadBtn').disabled = true;
    }
  </script>
</head>
<body>
  <div class="container">
    <div class="header" style="margin-bottom:10px;">
      <div class="title">ğŸ“ å—ä»˜å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆé™çš„ãƒ˜ãƒƒãƒ€ï¼‰</div>
      <div class="actions">
        <a class="btn ghost" href="?">â† ä¸€è¦§</a>
        <a class="btn" href="?page=debug">ğŸ”§ ãƒ‡ãƒãƒƒã‚°</a>
      </div>
    </div>
    <noscript>
      <div class="alert error">ã“ã®ãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹ã«ã¯JavaScriptã‚’æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„ã€‚</div>
    </noscript>
    <div id="root"><div class="alert">èª­ã¿è¾¼ã¿ä¸­...</div></div>
  </div>
</body>
</html>
