<!DOCTYPE html>
<html>
<head>
  <base target="_top" href="<?= ScriptApp.getService().getUrl() ?>">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>🧩 フォームビルダー CSV→JSON→HTML</title>
  <style>
    :root { --bg:#f6f8fb; --card:#fff; --text:#111827; --muted:#6b7280; --primary:#2563eb; --border:#e5e7eb; }
    *{ box-sizing:border-box; }
    body{ margin:0; background:linear-gradient(120deg,#eef2ff,#fdf2f8); font-family:-apple-system,BlinkMacSystemFont, 'Segoe UI', Roboto, 'Hiragino Kaku Gothic ProN', Meiryo, Arial, sans-serif; color:var(--text); }
    .container{ max-width:1200px; margin:0 auto; padding:20px; }
    .header{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px; display:flex; align-items:center; justify-content:space-between; gap:12px; box-shadow:0 8px 24px rgba(0,0,0,.06); }
    .title{ font-size:18px; font-weight:700; }
    .actions{ display:flex; gap:8px; }
    .btn{ appearance:none; border:1px solid var(--border); border-radius:10px; padding:8px 12px; background:#fff; cursor:pointer; }
    .btn.primary{ background:linear-gradient(135deg,#2563eb,#7c3aed); color:#fff; border:0; }
    .grid{ display:grid; grid-template-columns:1fr; gap:14px; }
    @media(min-width:900px){ .grid{ grid-template-columns:1fr 1fr; } }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px; box-shadow:0 8px 24px rgba(0,0,0,.06); }
    .label{ display:block; font-size:12px; color:var(--muted); margin:6px 0; }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    textarea{ width:100%; max-width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:#fafafa; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; }
    .jsonbox{ background:#0b1021; color:#c7d2fe; border-radius:12px; padding:12px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; overflow:auto; font-size:11px; max-height:340px; }
    .alert{ padding:10px 12px; border-radius:10px; margin-top:10px; border:1px solid var(--border); }
    .alert.success{ background:#ecfdf5; color:#065f46; border-color:#a7f3d0; }
    .alert.error{ background:#fef2f2; color:#991b1b; border-color:#fecaca; }
    iframe{ width:100%; height:360px; border:1px solid var(--border); border-radius:10px; background:#fff; }
    select, input[type="file"]{ padding:6px 8px; border:1px solid var(--border); border-radius:8px; background:#fff; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="title">🧩 フォームビルダー CSV→JSON→HTML</div>
      <div class="actions">
        <a class="btn" href="?">← 一覧</a>
        <a class="btn" href="?page=reception">📝 受付フォーム</a>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>📥 CSV 入力</h2>
        <div class="row">
          <label class="label">CSV ファイル</label>
          <input type="file" id="csvFile" accept=".csv,text/csv">
          <label class="label">文字コード</label>
          <select id="encoding">
            <option value="UTF-8">UTF-8</option>
            <option value="Shift_JIS">Shift_JIS</option>
          </select>
        </div>
        <div class="row">
          <label class="label">CSV テキスト（ペースト可）</label>
        </div>
        <textarea id="csvInput" rows="10" placeholder="ブロック名,タイトル,タイプ,ヒント,タイトル,タイプ,ヒント...&#10;受付,氏名,text,30文字まで,年齢,number,"></textarea>
        <div class="row" style="margin-top:10px; gap:10px;">
          <button class="btn primary" onclick="onConvert()">🔄 変換（CSV→MODEL/HTML）</button>
          <button class="btn" onclick="clearAll()">🗑️ クリア</button>
        </div>
        <div id="status" class="alert" style="display:none;"></div>
      </div>

      <div class="card">
        <h2>📦 変換結果</h2>
        <div class="row" style="gap:10px;">
          <button class="btn" onclick="downloadModel()" id="btnDownloadModel" disabled>💾 JSON ダウンロード</button>
          <button class="btn" onclick="downloadHtml()" id="btnDownloadHtml" disabled>💾 HTML ダウンロード</button>
        </div>
        <div class="row" style="margin-top:8px;">
          <label class="label">MODEL JSON</label>
          <div id="jsonOut" class="jsonbox"></div>
        </div>
        <div class="row" style="margin-top:8px;">
          <label class="label">HTML プレビュー</label>
          <iframe id="htmlPreview"></iframe>
        </div>
      </div>
    </div>
  </div>

  <script>
    const state = { csv: '', model: null, html: '' };

    document.getElementById('csvFile').addEventListener('change', async function(){
      const file = this.files && this.files[0];
      if (!file) return;
      const enc = document.getElementById('encoding').value || 'UTF-8';
      try {
        const reader = new FileReader();
        reader.onload = function(e){
          state.csv = e.target.result || '';
          document.getElementById('csvInput').value = state.csv;
        };
        reader.readAsText(file, enc);
      } catch (e) {
        showStatus('ファイル読込エラー: ' + (e.message||e), true);
      }
    });

    function onConvert(){
      const text = (document.getElementById('csvInput').value || '').trim();
      const csv = text || state.csv || '';
      if (!csv) { showStatus('CSV を入力してください', true); return; }
      showStatus('変換中...', false);

      google.script.run
        .withSuccessHandler(function(res){
          if (!res || !res.success) { showStatus('変換失敗: ' + (res && res.error || 'unknown'), true); return; }
          state.model = res.model; state.html = res.html;
          document.getElementById('jsonOut').textContent = JSON.stringify(state.model, null, 2);
          const iframe = document.getElementById('htmlPreview');
          if (iframe && 'srcdoc' in iframe) iframe.srcdoc = state.html; else iframe.contentWindow.document.write(state.html);
          document.getElementById('btnDownloadModel').disabled = false;
          document.getElementById('btnDownloadHtml').disabled = false;
          showStatus('変換成功', false, true);
        })
        .withFailureHandler(function(err){ showStatus('変換エラー: ' + (err && err.message || err), true); })
        .generateFormFromCsv(csv);
    }

    function clearAll(){
      state.csv=''; state.model=null; state.html='';
      document.getElementById('csvFile').value = '';
      document.getElementById('csvInput').value = '';
      document.getElementById('jsonOut').textContent = '';
      document.getElementById('htmlPreview').srcdoc = '';
      document.getElementById('btnDownloadModel').disabled = true;
      document.getElementById('btnDownloadHtml').disabled = true;
      showStatus('クリアしました', false, true);
    }

    function downloadModel(){
      if (!state.model) return;
      const blob = new Blob([JSON.stringify(state.model, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='form-model.json'; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
      showStatus('JSON をダウンロードしました', false, true);
    }
    function downloadHtml(){
      if (!state.html) return;
      const blob = new Blob([state.html], {type:'text/html'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='reception_generated.html'; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
      showStatus('HTML をダウンロードしました', false, true);
    }

    function showStatus(msg, isErr, solid){
      const el = document.getElementById('status');
      el.style.display = 'block';
      el.className = 'alert ' + (isErr ? 'error' : 'success');
      el.textContent = msg;
      if (!solid) setTimeout(()=>{ el.style.display='none'; }, 2500);
    }
  </script>
</body>
</html>

