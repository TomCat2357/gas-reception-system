<!DOCTYPE html>
<html>
<head>
  <base target="_top" href="<?= ScriptApp.getService().getUrl() ?>">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üìä „Éá„Éº„ÇøÊ§úÁ¥¢</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .header {
      background: white;
      border-radius: 15px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      text-align: center;
    }
    
    .header h1 {
      color: #333;
      font-size: 28px;
      margin-bottom: 10px;
    }
    .version-badge {
      display: inline-block;
      margin-left: 10px;
      padding: 4px 8px;
      font-size: 12px;
      color: #2563eb;
      background: #e8f0fe;
      border: 1px solid #c7d2fe;
      border-radius: 999px;
      vertical-align: middle;
    }
    
    .header p {
      color: #666;
      font-size: 16px;
    }
    
    .controls {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: center;
      justify-content: space-between;
    }
    
    .search-box {
      flex: 1;
      min-width: 250px;
      position: relative;
    }
    
    .search-box input {
      width: 100%;
      padding: 12px 45px 12px 15px;
      border: 2px solid #e1e8ed;
      border-radius: 8px;
      font-size: 14px;
      background: #fafbfc;
      transition: all 0.3s ease;
    }
    
    .search-box input:focus {
      outline: none;
      border-color: #4285f4;
      background: white;
      box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
    }
    
    .search-icon {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #666;
      font-size: 16px;
    }
    
    .btn {
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #4285f4, #34a853);
      color: white;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(66, 133, 244, 0.3);
    }
    
    .btn-secondary {
      background: #f8f9fa;
      color: #666;
      border: 2px solid #e1e8ed;
    }
    
    .btn-secondary:hover {
      background: #e9ecef;
      border-color: #adb5bd;
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #dc3545, #c82333);
      color: white;
    }
    
    .btn-danger:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3);
    }
    
    .data-container {
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    
    .data-header {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .data-title {
      font-size: 20px;
      font-weight: 600;
    }
    
    .data-count {
      background: rgba(255,255,255,0.2);
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 14px;
    }
    
    .table-container {
      overflow-x: auto;
      max-height: 600px;
      overflow-y: auto;
    }
    
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .data-table th {
      background: #f8f9fa;
      padding: 15px 12px;
      text-align: left;
      font-weight: 600;
      color: #333;
      border-bottom: 2px solid #e1e8ed;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .data-table td {
      padding: 12px;
      border-bottom: 1px solid #e1e8ed;
      vertical-align: middle;
    }
    
    .data-table tr:hover {
      background: #f8f9fa;
    }
    
    .action-buttons {
      display: flex;
      gap: 8px;
    }
    
    .btn-sm {
      padding: 6px 12px;
      font-size: 12px;
      min-width: auto;
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }
    
    .empty-state .icon {
      font-size: 48px;
      margin-bottom: 20px;
      opacity: 0.5;
    }
    
    .empty-state h3 {
      margin-bottom: 10px;
      color: #333;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    
    .loading .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #4285f4;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      animation: fadeIn 0.3s ease;
    }
    
    .modal.show {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal-content {
      background: white;
      border-radius: 15px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      animation: slideIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideIn {
      from { transform: translateY(-50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
      font-size: 14px;
    }
    
    .required {
      color: #e74c3c;
    }
    
    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e1e8ed;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s ease;
      background: #fafbfc;
    }
    
    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #4285f4;
      background: white;
      box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
    }
    
    .form-group textarea {
      resize: vertical;
      min-height: 80px;
      font-family: inherit;
    }
    
    .modal-buttons {
      margin-top: 30px;
      display: flex;
      gap: 15px;
      justify-content: flex-end;
    }
    
    .alert {
      padding: 12px 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      border-left: 4px solid;
    }
    
    .alert-success {
      background: #d4edda;
      color: #155724;
      border-left-color: #28a745;
    }
    
    .alert-error {
      background: #f8d7da;
      color: #721c24;
      border-left-color: #dc3545;
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }
      
      .controls {
        flex-direction: column;
        align-items: stretch;
      }
      
      .search-box {
        min-width: auto;
      }
      
      .data-table {
        font-size: 12px;
      }
      
      .data-table th,
      .data-table td {
        padding: 8px 6px;
      }
      
      .action-buttons {
        flex-direction: column;
      }
      
      .modal-content {
        padding: 20px;
        width: 95%;
      }
      
      .modal-buttons {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- „Éò„ÉÉ„ÉÄ„Éº -->
    <div class="header">
      <h1>üìä „Éá„Éº„ÇøÊ§úÁ¥¢ <span class="version-badge">ver.20250911_181423</span></h1>
      <p>„Éá„Éº„Çø„ÅÆÊ§úÁ¥¢„Å®Á∑®ÈõÜÔºà‰∏ãÈÉ®„Å´ÁµêÊûúË°®Á§∫Ôºâ</p>
    </div>
    
    <!-- „Ç≥„É≥„Éà„É≠„Éº„É´ -->
    <div class="controls">
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="üîç „Éá„Éº„Çø„ÇíÊ§úÁ¥¢...">
        <span class="search-icon">üîç</span>
      </div>
      <a class="btn btn-primary" href="?page=reception">üìù Êñ∞Ë¶èÂèó‰ªò</a>
      <a class="btn btn-secondary" href="?page=form_builder">üß© „Éï„Ç©„Éº„É†„Éì„É´„ÉÄ„Éº</a>
      <button class="btn btn-secondary" onclick="loadData()">
        üîÑ Êõ¥Êñ∞
      </button>
      <button class="btn btn-secondary" onclick="showSpreadsheetInfo()">
        üìä „Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„ÉàÊÉÖÂ†±
      </button>
      <button class="btn btn-secondary" onclick="testServerConnection()">
        üîß „Çµ„Éº„Éê„ÉºÁñéÈÄö„ÉÜ„Çπ„Éà
      </button>
    </div>
    
    <!-- „Éá„Éº„ÇøË°®Á§∫„Ç®„É™„Ç¢ -->
    <div class="data-container">
      <div class="data-header">
        <div class="data-title">üìã „Éá„Éº„Çø‰∏ÄË¶ß</div>
        <div class="data-count" id="dataCount">-</div>
      </div>
      
      <div id="dataContent">
        <div class="loading">
          <div class="spinner"></div>
          <div>„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>
        </div>
      </div>
    </div>
  </div>
  <div style="text-align:center; margin-top:12px; color:#666; font-size:12px;">
    „Éê„Éº„Ç∏„Éß„É≥: ver.20250911_181423
  </div>
  
  <!-- „Éá„Éº„ÇøÁ∑®ÈõÜ„É¢„Éº„ÉÄ„É´ -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <h3 id="modalTitle">üìù „Éá„Éº„ÇøÁ∑®ÈõÜ</h3>
      <div id="alertArea"></div>
      
      <form id="dataForm">
        <input type="hidden" id="editRowIndex" value="">
        
        
        
        <div class="modal-buttons">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">
            ‚ùå „Ç≠„É£„É≥„Çª„É´
          </button>
          <button type="button" class="btn btn-primary" onclick="saveData()">
            üíæ ‰øùÂ≠ò
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let allData = [];
    let filteredData = [];
    
    // ÂàùÊúüÂåñ
    document.addEventListener('DOMContentLoaded', function() {
      loadData();
      
      // Ê§úÁ¥¢Ê©üËÉΩ
      document.getElementById('searchInput').addEventListener('input', function() {
        filterData(this.value);
      });
    });
    
    // „Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø
    function loadData() {
      showLoading();
      
      // „Çø„Ç§„É†„Ç¢„Ç¶„ÉàÂá¶ÁêÜÔºà30ÁßíÔºâ
      const timeoutId = setTimeout(() => {
        showAlert('„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Åå„Çø„Ç§„É†„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü„ÄÇ„Éö„Éº„Ç∏„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
        showEmptyState('„Çø„Ç§„É†„Ç¢„Ç¶„Éà„Ç®„É©„Éº');
      }, 30000);
      
      google.script.run
        .withSuccessHandler((data) => {
          clearTimeout(timeoutId);
          onDataLoaded(data);
        })
        .withFailureHandler((error) => {
          clearTimeout(timeoutId);
          onLoadError(error);
        })
        .listReceptionIndex();
    }
    
    // „Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÊàêÂäüÊôÇ
    function onDataLoaded(data) {
      console.log('Reception data loaded:', data);
      console.log('Data type:', typeof data, 'Is array:', Array.isArray(data));
      
      // „Éá„Éº„Çø„ÅÆÊ§úË®º
      if (!data || !Array.isArray(data)) {
        console.error('Invalid data format received:', data);
        showAlert('ÁÑ°Âäπ„Å™„Éá„Éº„ÇøÂΩ¢Âºè„ÇíÂèó‰ø°„Åó„Åæ„Åó„Åü', 'error');
        showEmptyState('„Éá„Éº„ÇøÂΩ¢Âºè„Ç®„É©„Éº');
        return;
      }
      
      allData = data;
      filteredData = data;
      renderData();
      updateDataCount();
    }
    
    // „Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„ÉºÊôÇ
    function onLoadError(error) {
      console.error('Load error details:', error);
      
      let errorMessage = '„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü';
      if (error && error.message) {
        errorMessage += ': ' + error.message;
      } else if (typeof error === 'string') {
        errorMessage += ': ' + error;
      }
      
      showAlert(errorMessage, 'error');
      
      // „Éá„Éê„ÉÉ„Ç∞Áî®„ÅÆ„Éú„Çø„É≥„ÇíËøΩÂä†
      const debugButton = '<button class="btn btn-secondary" onclick="loadDebugInfo()">üîß „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±„ÇíË°®Á§∫</button>';
      
      document.getElementById('dataContent').innerHTML = `
        <div class="empty-state">
          <div class="icon">‚ùå</div>
          <h3>„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü</h3>
          <p>„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ</p>
          <div style="margin-top: 20px;">
            ${debugButton}
          </div>
        </div>
      `;
    }
    
    // „Éá„Éº„Çø„Çí„É¨„É≥„ÉÄ„É™„É≥„Ç∞
    function renderData() {
      const contentDiv = document.getElementById('dataContent');
      
      // filteredData„ÅÆÂ≠òÂú®Á¢∫Ë™ç
      if (!filteredData || !Array.isArray(filteredData)) {
        console.error('filteredData is not valid:', filteredData);
        showEmptyState('„Éá„Éº„Çø„ÅÆÂΩ¢Âºè„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì');
        return;
      }
      
      if (filteredData.length === 0) {
        showEmptyState();
        return;
      }
      
      let html = `
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>üÜî ID</th>
                <th>üìÖ Âèó‰ªòÊó•</th>
                <th>üéØ ÂØæË±°</th>
                <th>üë§ ÊãÖÂΩì</th>
                <th>üìç Âå∫</th>
                <th>‚òé Âïè„ÅÑÂêà„Çè„Åõ</th>
                <th>üìö Áõ∏Ë´áÁ®ÆÈ°û</th>
                <th>üõ† ÂØæÂøúÁ®ÆÈ°û</th>
                <th>üìù Áõ∏Ë´áË©≥Á¥∞</th>
                <th>üìÖ ‰ΩúÊàê</th>
                <th>üîÑ Êõ¥Êñ∞</th>
                <th>‚öôÔ∏è Êìç‰Ωú</th>
              </tr>
            </thead>
            <tbody>
      `;
      
      filteredData.forEach((row, index) => {
        // row„ÅÆÂ≠òÂú®Á¢∫Ë™ç
        if (!row || !Array.isArray(row)) {
          console.warn('Invalid row data at index', index, ':', row);
          return;
        }
        
        const originalIndex = allData.indexOf(row);
        
        // ÂêÑ„Çª„É´„ÅÆ„Éá„Éº„Çø„ÇíÂÆâÂÖ®„Å´Âá¶ÁêÜ
        const id = escapeHtml(row[0] || '');
        const date = escapeHtml(row[1] || '');
        const target = escapeHtml(row[2] || '');
        const assignee = escapeHtml(row[3] || '');
        const ward = escapeHtml(row[4] || '');
        const contact = escapeHtml(row[5] || '');
        const consultTypes = escapeHtml(row[6] || '');
        const responseTypes = escapeHtml(row[7] || '');
        const details = escapeHtml(row[8] || '');
        const createdAt = formatDateTime(row[9]);
        const updatedAt = formatDateTime(row[10]);

        html += `
          <tr>
            <td><strong>${id}</strong></td>
            <td>${date}</td>
            <td>${target}</td>
            <td>${assignee}</td>
            <td>${ward}</td>
            <td>${contact}</td>
            <td>${consultTypes}</td>
            <td>${responseTypes}</td>
            <td>${details}</td>
            <td>${createdAt}</td>
            <td>${updatedAt}</td>
            <td>
              <div class="action-buttons">
                <button class="btn btn-primary btn-sm" onclick="openReception('${id}')">
                  ‚úèÔ∏è Á∑®ÈõÜ
                </button>
              </div>
            </td>
          </tr>
        `;
      });
      
      html += `
            </tbody>
          </table>
        </div>
      `;
      
      contentDiv.innerHTML = html;
    }
    
    // „Éï„Ç£„Éº„É´„Éâ„ÅÆ„Ç®„Ç§„É™„Ç¢„ÇπÔºàkey = ÂÜÖÈÉ®Âêç„ÄÅvalue = Â§ñÈÉ®Âêç„ÅÆÈÖçÂàóÔºâ
    const DEFAULT_FIELD_ALIASES = {
      id: ['id','ID','üÜî'],
      date: ['Âèó‰ªòÊó•','date','Âèó‰ªòÊó•ÊôÇ'],
      target: ['ÂØæË±°','Áõ∏Ë´áÂØæË±°','target'],
      assignee: ['ÊãÖÂΩì','assignee'],
      ward: ['Âå∫','ward'],
      contact: ['Âïè„ÅÑÂêà„Çè„Åõ','Âïè„ÅÑÂêà„Çè„ÅõÊñπÊ≥ï','contact'],
      consult: ['Áõ∏Ë´áÁ®ÆÈ°û','consultationTypes','Áõ∏Ë´á'],
      response: ['ÂØæÂøúÁ®ÆÈ°û','responseTypes','ÂØæÂøú'],
      details: ['Áõ∏Ë´áË©≥Á¥∞','details','Ë©≥Á¥∞'],
      created: ['createdAt', '‰ΩúÊàêÊó•ÊôÇ', '‰ΩúÊàêÊó•', 'created'],
      updated: ['updatedAt', 'Êõ¥Êñ∞Êó•ÊôÇ', 'Êõ¥Êñ∞Êó•'],
    };

    // Êó•ÊôÇÊØîËºÉÂØæË±°ÔºàÊ≠£Ë¶èÂåñÂæå„ÅÆ„Ç´„Éé„Éã„Ç´„É´ÂêçÔºâ
    const DATE_FIELD_CANONICALS = new Set(['date','created', 'updated']);

    // ÈÖçÂàóÂΩ¢Âºè„ÅÆ„Éá„Éº„Çø„ÇíÈÄ£ÊÉ≥ÈÖçÂàóÂΩ¢Âºè„Å´Â§âÊèõ
    function convertRowToObject(row) {
      return {
        id: row[0],
        date: row[1] || '',
        target: row[2] || '',
        assignee: row[3] || '',
        ward: row[4] || '',
        contact: row[5] || '',
        consult: row[6] || '',
        response: row[7] || '',
        details: row[8] || '',
        created: row[9] || '',
        updated: row[10] || ''
      };
    }

    function openReception(id){
      window.location.href = '?page=reception&id=' + encodeURIComponent(id);
    }

    // È´òÂ∫¶Ê§úÁ¥¢Ê©üËÉΩÔºàcolumn-regex-filter.js „Åã„ÇâÁßªÊ§çÔºâ
    function compileQuery(input, opts) {
      opts = opts || {};
      var defaultFlags = opts.defaultFlags || 'i';
      var normalize = opts.normalize !== false;

      if (!input || typeof input !== 'string') {
        return { clauses: [] };
      }

      var text = normalize ? normalizeText(input) : input;
      var clauses = parseQuery(text);

      clauses.forEach(function(clause) {
        clause.conditions.forEach(function(cond) {
          if (cond.type === 'regex' && cond.pattern) {
            try {
              var flags = cond.flags || defaultFlags;
              cond.compiledRegex = new RegExp(cond.pattern, flags);
            } catch (e) {
              console.warn('Invalid regex pattern:', cond.pattern, e.message);
              cond.compiledRegex = null;
            }
          }
        });
      });

      return { clauses: clauses };
    }

    function parseQuery(text) {
      var orParts = text.split(/\s+OR\s+/);
      return orParts.map(function(part) {
        var conditions = [];
        var tokens = tokenize(part);
        
        tokens.forEach(function(token) {
          if (token.field) {
            var field = normalizeFieldName(token.field);
            if (field) {
              conditions.push({
                type: token.isRegex ? 'regex' : (DATE_FIELD_CANONICALS.has(field) ? 'date' : 'text'),
                field: field,
                pattern: token.value,
                operator: token.operator || '=',
                flags: token.flags,
                originalValue: token.value
              });
            }
          } else {
            conditions.push({
              type: token.isRegex ? 'regex' : 'global',
              pattern: token.value,
              flags: token.flags
            });
          }
        });
        
        return { conditions: conditions };
      });
    }

    function tokenize(text) {
      var tokens = [];
      var regex = /(\w+):(>=|<=|>|<|=)?(?:\/(.+?)\/([gimuy]*)|"([^"]*)"|(\S+))|(?:\/(.+?)\/([gimuy]*)|"([^"]*)"|(\S+))/g;
      var match;

      while ((match = regex.exec(text)) !== null) {
        if (match[1]) {
          var field = match[1];
          var operator = match[2] || '=';
          var regexPattern = match[3];
          var regexFlags = match[4];
          var quotedValue = match[5];
          var plainValue = match[6];
          
          tokens.push({
            field: field,
            operator: operator,
            value: regexPattern || quotedValue || plainValue || '',
            isRegex: !!regexPattern,
            flags: regexFlags
          });
        } else {
          var globalRegexPattern = match[7];
          var globalRegexFlags = match[8];
          var globalQuotedValue = match[9];
          var globalPlainValue = match[10];
          
          tokens.push({
            value: globalRegexPattern || globalQuotedValue || globalPlainValue || '',
            isRegex: !!globalRegexPattern,
            flags: globalRegexFlags
          });
        }
      }

      return tokens;
    }

    function normalizeFieldName(fieldName) {
      var lower = fieldName.toLowerCase();
      for (var canonical in DEFAULT_FIELD_ALIASES) {
        var aliases = DEFAULT_FIELD_ALIASES[canonical];
        for (var i = 0; i < aliases.length; i++) {
          if (aliases[i].toLowerCase() === lower) {
            return canonical;
          }
        }
      }
      return null;
    }

    function normalizeText(text) {
      return text.normalize('NFKC');
    }

    function filterRows(rows, compiled, opts) {
      opts = opts || {};
      
      if (!compiled.clauses || compiled.clauses.length === 0) {
        return rows;
      }

      return rows.filter(function(row) {
        var obj = convertRowToObject(row);
        return compiled.clauses.some(function(clause) {
          return clause.conditions.every(function(cond) {
            return matchCondition(obj, cond);
          });
        });
      });
    }

    function matchCondition(obj, cond) {
      if (cond.type === 'global') {
        return Object.values(obj).some(function(value) {
          if (value == null) return false;
          var str = String(value);
          if (cond.compiledRegex) {
            return cond.compiledRegex.test(str);
          } else {
            return str.toLowerCase().includes(cond.pattern.toLowerCase());
          }
        });
      }

      var fieldValue = obj[cond.field];
      if (fieldValue == null) return false;

      if (cond.type === 'date') {
        return compareDates(fieldValue, cond.pattern, cond.operator);
      }

      var str = String(fieldValue);
      if (cond.compiledRegex) {
        return cond.compiledRegex.test(str);
      } else {
        return str.toLowerCase().includes(cond.pattern.toLowerCase());
      }
    }

    function compareDates(fieldValue, pattern, operator) {
      try {
        var fieldDate = new Date(fieldValue);
        var patternDate = new Date(pattern);
        
        if (isNaN(fieldDate.getTime()) || isNaN(patternDate.getTime())) {
          return false;
        }

        switch (operator) {
          case '>=': return fieldDate >= patternDate;
          case '<=': return fieldDate <= patternDate;
          case '>': return fieldDate > patternDate;
          case '<': return fieldDate < patternDate;
          case '=':
          default: return fieldDate.getTime() === patternDate.getTime();
        }
      } catch (e) {
        return false;
      }
    }

    // Ê§úÁ¥¢„Éï„Ç£„É´„Çø„É™„É≥„Ç∞ÔºàÈ´òÂ∫¶Ê§úÁ¥¢ÂØæÂøúÁâàÔºâ
    function filterData(searchTerm) {
      if (!searchTerm.trim()) {
        filteredData = allData;
      } else {
        const compiled = compileQuery(searchTerm, { defaultFlags: 'i', normalize: true });
        filteredData = filterRows(allData, compiled);
      }
      renderData();
      updateDataCount();
    }
    
    // „Éá„Éº„Çø‰ª∂Êï∞„ÇíÊõ¥Êñ∞
    function updateDataCount() {
      const countElement = document.getElementById('dataCount');
      countElement.textContent = `${filteredData.length} / ${allData.length} ‰ª∂`;
    }
    
    // „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫
    function showLoading() {
      document.getElementById('dataContent').innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <div>„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>
        </div>
      `;
    }
    
    // Á©∫Áä∂ÊÖãË°®Á§∫
    function showEmptyState(message = '„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì') {
      document.getElementById('dataContent').innerHTML = `
        <div class="empty-state">
          <div class="icon">üìÇ</div>
          <h3>${message}</h3>
          <p>„ÄåÊñ∞Ë¶èËøΩÂä†„Äç„Éú„Çø„É≥„Åã„ÇâÊúÄÂàù„ÅÆ„Éá„Éº„Çø„ÇíÁôªÈå≤„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
        </div>
      `;
    }
    
    // Êñ∞Ë¶èËøΩÂä†„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
    function showAddModal() {
      document.getElementById('modalTitle').textContent = '‚ûï Êñ∞Ë¶è„Éá„Éº„ÇøËøΩÂä†';
      document.getElementById('editRowIndex').value = '';
      resetForm();
      showModal();
    }
    
    // Á∑®ÈõÜ„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
    function showEditModal(index) {
      const data = allData[index];
      document.getElementById('modalTitle').textContent = '‚úèÔ∏è „Éá„Éº„ÇøÁ∑®ÈõÜ';
      document.getElementById('editRowIndex').value = index;
      
      // „Éá„Éº„Çø‰ª•Â§ñ„ÅÆÁ∑®ÈõÜ„Éï„Ç£„Éº„É´„Éâ„ÅØÂªÉÊ≠¢„Åó„Åæ„Åó„Åü
      
      showModal();
    }
    
    // „É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
    function showModal() {
      document.getElementById('editModal').classList.add('show');
      clearAlert();
    }
    
    // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
    function closeModal() {
      document.getElementById('editModal').classList.remove('show');
    }
    
    // „Éï„Ç©„Éº„É†„Çí„É™„Çª„ÉÉ„Éà
    function resetForm() {
      document.getElementById('dataForm').reset();
    }
    
    // „Éá„Éº„Çø„Çí‰øùÂ≠ò
    function saveData() {
      // „Åì„ÅÆÁîªÈù¢„Åß„ÅÆÁ∑®ÈõÜ„ÅØÁÑ°ÂäπÂåñ„Åï„Çå„Å¶„ÅÑ„Åæ„ÅôÔºà„Éá„Éº„ÇøÂ∞ÇÁî®„Å∏ÁßªË°åÔºâ
      showAlert('„Åì„ÅÆÁîªÈù¢„Åß„ÅÆÁ∑®ÈõÜ„ÅØÁÑ°ÂäπÂåñ„Åï„Çå„Å¶„ÅÑ„Åæ„ÅôÔºà„Éá„Éº„Çø„Çí„ÅîÂà©Áî®„Åè„Å†„Åï„ÅÑÔºâ', 'error');
      return;
      
      // Set loading state
      setLoadingState(true);
      
      // Collect form dataÔºàÁÑ°ÂäπÂåñÔºâ
      const formData = {};
      
      const rowIndex = document.getElementById('editRowIndex').value;
      
      console.log('Starting save:', formData, 'rowIndex:', rowIndex);
      
      // Set timeout (30 seconds)
      const timeoutId = setTimeout(() => {
        setLoadingState(false);
        showAlert('Âá¶ÁêÜ„Åå„Çø„Ç§„É†„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü„ÄÇÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
      }, 30000);
      
      if (rowIndex === '') {
        // Add new data
        console.log('Adding new data...');
        google.script.run
          .withSuccessHandler((result) => {
            clearTimeout(timeoutId);
            onSaveSuccess(result);
          })
          .withFailureHandler((error) => {
            clearTimeout(timeoutId);
            onSaveError(error);
          })
          .addNewData(formData);
      } else {
        // Update existing data
        console.log('Updating data...');
        google.script.run
          .withSuccessHandler((result) => {
            clearTimeout(timeoutId);
            onSaveSuccess(result);
          })
          .withFailureHandler((error) => {
            clearTimeout(timeoutId);
            onSaveError(error);
          })
          .updateData(formData, parseInt(rowIndex) + 2);
      }
    }
    
    // Manage loading state
    function setLoadingState(isLoading) {
      const saveBtn = document.querySelector('.modal-buttons .btn-primary');
      const modalContent = document.querySelector('.modal-content');
      
      if (isLoading) {
        saveBtn.innerHTML = 'üíæ ‰øùÂ≠ò‰∏≠...';
        saveBtn.disabled = true;
        modalContent.style.opacity = '0.7';
        modalContent.style.pointerEvents = 'none';
      } else {
        saveBtn.innerHTML = 'üíæ ‰øùÂ≠ò';
        saveBtn.disabled = false;
        modalContent.style.opacity = '1';
        modalContent.style.pointerEvents = 'auto';
      }
    }
    
    // Save success handler
    function onSaveSuccess(message) {
      console.log('Save success:', message);
      setLoadingState(false);
      showAlert(message, 'success');
      setTimeout(() => {
        closeModal();
        loadData();
      }, 1500);
    }
    
    // Save error handler
    function onSaveError(error) {
      console.error('Save error:', error);
      setLoadingState(false);
      showAlert('‰øùÂ≠ò‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + (error.message || error), 'error');
    }
    
    // ÂâäÈô§Á¢∫Ë™ç
    function confirmDelete(index) {
      const data = allData[index];
      const label = `Ë°å ${index+1}`;
      if (confirm(`„Äå${label}„Äç„ÇíÂâäÈô§„Åó„Å¶„ÇÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü\n„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ`)) {
        google.script.run
          .withSuccessHandler(onDeleteSuccess)
          .withFailureHandler(onDeleteError)
          .deleteData(index + 2); // „Éò„ÉÉ„ÉÄ„ÉºÂàÜ+1„ÄÅ0„Éô„Éº„ÇπË™øÊï¥+1
      }
    }
    
    // ÂâäÈô§ÊàêÂäüÊôÇ
    function onDeleteSuccess(message) {
      showAlert(message, 'success');
      loadData();
    }
    
    // ÂâäÈô§„Ç®„É©„ÉºÊôÇ
    function onDeleteError(error) {
      showAlert('ÂâäÈô§‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
    }
    
    // „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±„ÇíË™≠„ÅøËæº„Åø
    function loadDebugInfo() {
      showLoading();
      
      google.script.run
        .withSuccessHandler((debugInfo) => {
          console.log('Debug info:', debugInfo);
          
          const formattedInfo = `
            <div class="debug-info" style="text-align: left; font-family: monospace; font-size: 12px; background: #f5f5f5; padding: 15px; border-radius: 5px; margin: 10px; white-space: pre-wrap;">
              ${JSON.stringify(debugInfo, null, 2)}
            </div>
          `;
          
          document.getElementById('dataContent').innerHTML = `
            <div class="empty-state">
              <div class="icon">üîß</div>
              <h3>„Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±</h3>
              ${formattedInfo}
              <div style="margin-top: 20px;">
                <button class="btn btn-secondary" onclick="loadData()">üîÑ ÂÜçË©¶Ë°å</button>
              </div>
            </div>
          `;
        })
        .withFailureHandler((error) => {
          console.error('Debug info error:', error);
          showAlert('„Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (error.message || error), 'error');
        })
        .debugGetAllData();
    }
    
    // „Ç¢„É©„Éº„ÉàË°®Á§∫
    function showAlert(message, type) {
      const alertArea = document.getElementById('alertArea') || document.createElement('div');
      
      if (!document.getElementById('alertArea')) {
        alertArea.id = 'alertArea';
        document.querySelector('.container').insertBefore(alertArea, document.querySelector('.data-container'));
      }
      
      const className = type === 'success' ? 'alert-success' : 'alert-error';
      alertArea.innerHTML = `<div class="alert ${className}">${message}</div>`;
      
      if (type === 'error') {
        setTimeout(clearAlert, 15000);
      }
    }
    
    // „Ç¢„É©„Éº„Éà„ÇØ„É™„Ç¢
    function clearAlert() {
      document.getElementById('alertArea').innerHTML = '';
    }
    
    // HTML„Ç®„Çπ„Ç±„Éº„Éó
    function escapeHtml(text) {
      // null, undefined, Êï∞ÂÄ§„Å™„Å©„ÇíÊñáÂ≠óÂàó„Å´Â§âÊèõ
      if (text === null || text === undefined) {
        return '';
      }
      
      // Êï∞ÂÄ§„ÇÑ„Åù„ÅÆ‰ªñ„ÅÆ„Çø„Ç§„Éó„ÇíÊñáÂ≠óÂàó„Å´Â§âÊèõ
      const textStr = String(text);
      
      const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      };
      return textStr.replace(/[&<>"']/g, function(m) { return map[m]; });
    }
    
    // Êó•ÊôÇ„Éï„Ç©„Éº„Éû„ÉÉ„Éà
    function formatDateTime(dateValue) {
      if (!dateValue) return '';
      
      try {
        const date = new Date(dateValue);
        if (isNaN(date.getTime())) return '';
        
        return date.toLocaleString('ja-JP', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        });
      } catch (e) {
        return '';
      }
    }
    
    // „Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„ÉàÊÉÖÂ†±„ÇíË°®Á§∫
    function showSpreadsheetInfo() {
      google.script.run
        .withSuccessHandler((info) => {
          let infoHtml = '<h3>üìä „Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„ÉàÊÉÖÂ†±</h3>';
          
          if (info.spreadsheetInfo && info.spreadsheetInfo.id) {
            infoHtml += `
              <div style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <p><strong>ID:</strong> ${info.spreadsheetInfo.id}</p>
                <p><strong>ÂêçÂâç:</strong> ${info.spreadsheetInfo.name}</p>
                <p><strong>URL:</strong> <a href="${info.spreadsheetInfo.url}" target="_blank">„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„ÇíÈñã„Åè</a></p>
                <p><strong>„Ç∑„Éº„Éà‰∏ÄË¶ß:</strong> ${info.spreadsheetInfo.sheets.join(', ')}</p>
              </div>
            `;
          } else {
            infoHtml += '<p>„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„ÉàÊÉÖÂ†±„ÅåÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ</p>';
          }
          
          // „É¢„Éº„ÉÄ„É´„Çí‰ΩúÊàê„Åó„Å¶Ë°®Á§∫
          const modal = document.createElement('div');
          modal.className = 'modal show';
          modal.innerHTML = `
            <div class="modal-content">
              ${infoHtml}
              <div class="modal-buttons">
                <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">
                  ‚ùå Èñâ„Åò„Çã
                </button>
              </div>
            </div>
          `;
          
          // „É¢„Éº„ÉÄ„É´Â§ñ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
          modal.addEventListener('click', function(e) {
            if (e.target === modal) {
              modal.remove();
            }
          });
          
          document.body.appendChild(modal);
        })
        .withFailureHandler((error) => {
          showAlert('„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„ÉàÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (error.message || error), 'error');
        })
        .debugSpreadsheetInfo();
    }
    
    // „Çµ„Éº„Éê„ÉºÁñéÈÄö„ÉÜ„Çπ„Éà
    function testServerConnection() {
      console.log('=== CLIENT: Testing server connection ===');
      
      // „Ç∑„É≥„Éó„É´„Å™„ÉÜ„Çπ„Éà
      google.script.run
        .withSuccessHandler((result) => {
          console.log('=== CLIENT: Simple test success ===', result);
          showAlert('„Ç∑„É≥„Éó„É´„ÉÜ„Çπ„ÉàÊàêÂäü: ' + result, 'success');
          
          // ping„ÉÜ„Çπ„Éà
          google.script.run
            .withSuccessHandler((pingResult) => {
              console.log('=== CLIENT: Ping test success ===', pingResult);
              showAlert('Ping„ÉÜ„Çπ„ÉàÊàêÂäü: ' + JSON.stringify(pingResult), 'success');
              
              // getAllDataSafe„ÉÜ„Çπ„Éà
              google.script.run
                .withSuccessHandler((dataResult) => {
                  console.log('=== CLIENT: getAllDataSafe test success ===', dataResult);
                  showAlert('„Éá„Éº„ÇøÂèñÂæó„ÉÜ„Çπ„ÉàÁµêÊûú: ' + (dataResult ? '„Éá„Éº„Çø„ÅÇ„Çä' : 'null'), dataResult ? 'success' : 'error');
                  
                  // Ë©≥Á¥∞„Éá„Éê„ÉÉ„Ç∞„ÉÜ„Çπ„Éà
                  google.script.run
                    .withSuccessHandler((debugResult) => {
                      console.log('=== CLIENT: Debug step test success ===', debugResult);
                      showAlert('Ë©≥Á¥∞„Éá„Éê„ÉÉ„Ç∞ÁµêÊûú: ' + debugResult, 'success');
                    })
                    .withFailureHandler((error) => {
                      console.error('=== CLIENT: Debug step test failed ===', error);
                      showAlert('Ë©≥Á¥∞„Éá„Éê„ÉÉ„Ç∞Â§±Êïó: ' + (error.message || error), 'error');
                    })
                    .debugGetAllDataStep();
                })
                .withFailureHandler((error) => {
                  console.error('=== CLIENT: getAllDataSafe test failed ===', error);
                  showAlert('„Éá„Éº„ÇøÂèñÂæó„ÉÜ„Çπ„ÉàÂ§±Êïó: ' + (error.message || error), 'error');
                })
                .getAllDataSafe();
            })
            .withFailureHandler((error) => {
              console.error('=== CLIENT: Ping test failed ===', error);
              showAlert('Ping„ÉÜ„Çπ„ÉàÂ§±Êïó: ' + (error.message || error), 'error');
            })
            .pingTest();
        })
        .withFailureHandler((error) => {
          console.error('=== CLIENT: Simple test failed ===', error);
          showAlert('„Ç∑„É≥„Éó„É´„ÉÜ„Çπ„ÉàÂ§±Êïó: ' + (error.message || error), 'error');
        })
        .simpleTest();
    }
    
    // „É¢„Éº„ÉÄ„É´Â§ñ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
    document.getElementById('editModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeModal();
      }
    });
  </script>
</body>
</html>


