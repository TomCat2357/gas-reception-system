<!DOCTYPE html>
<html>
<head>
  <base target="_top" href="<?= ScriptApp.getService().getUrl() ?>">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ“Š ãƒ‡ãƒ¼ã‚¿æ¤œç´¢</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .header {
      background: white;
      border-radius: 15px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      text-align: center;
    }
    
    .header h1 {
      color: #333;
      font-size: 28px;
      margin-bottom: 10px;
    }
    .version-badge {
      display: inline-block;
      margin-left: 10px;
      padding: 4px 8px;
      font-size: 12px;
      color: #2563eb;
      background: #e8f0fe;
      border: 1px solid #c7d2fe;
      border-radius: 999px;
      vertical-align: middle;
    }
    
    .header p {
      color: #666;
      font-size: 16px;
    }
    
    .controls {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: center;
      justify-content: space-between;
    }
    
    .search-box {
      flex: 1;
      min-width: 250px;
      position: relative;
    }
    
    .search-box input {
      width: 100%;
      padding: 12px 45px 12px 15px;
      border: 2px solid #e1e8ed;
      border-radius: 8px;
      font-size: 14px;
      background: #fafbfc;
      transition: all 0.3s ease;
    }
    
    .search-box input:focus {
      outline: none;
      border-color: #4285f4;
      background: white;
      box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
    }
    
    .search-icon {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #666;
      font-size: 16px;
    }
    
    .btn {
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #4285f4, #34a853);
      color: white;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(66, 133, 244, 0.3);
    }
    
    .btn-secondary {
      background: #f8f9fa;
      color: #666;
      border: 2px solid #e1e8ed;
    }
    
    .btn-secondary:hover {
      background: #e9ecef;
      border-color: #adb5bd;
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #dc3545, #c82333);
      color: white;
    }
    
    .btn-danger:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3);
    }
    
    .data-container {
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    
    .data-header {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .data-title {
      font-size: 20px;
      font-weight: 600;
    }
    
    .data-count {
      background: rgba(255,255,255,0.2);
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 14px;
    }
    
    .table-container {
      overflow-x: auto;
      max-height: 600px;
      overflow-y: auto;
    }
    
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .data-table th {
      background: #f8f9fa;
      padding: 15px 12px;
      text-align: left;
      font-weight: 600;
      color: #333;
      border-bottom: 2px solid #e1e8ed;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .data-table td {
      padding: 12px;
      border-bottom: 1px solid #e1e8ed;
      vertical-align: middle;
    }
    
    .data-table tr:hover {
      background: #f8f9fa;
    }
    
    .action-buttons {
      display: flex;
      gap: 8px;
    }
    
    .btn-sm {
      padding: 6px 12px;
      font-size: 12px;
      min-width: auto;
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }
    
    .empty-state .icon {
      font-size: 48px;
      margin-bottom: 20px;
      opacity: 0.5;
    }
    
    .empty-state h3 {
      margin-bottom: 10px;
      color: #333;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    
    .loading .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #4285f4;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      animation: fadeIn 0.3s ease;
    }
    
    .modal.show {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal-content {
      background: white;
      border-radius: 15px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      animation: slideIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideIn {
      from { transform: translateY(-50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
      font-size: 14px;
    }
    
    .required {
      color: #e74c3c;
    }
    
    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e1e8ed;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s ease;
      background: #fafbfc;
    }
    
    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #4285f4;
      background: white;
      box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
    }
    
    .form-group textarea {
      resize: vertical;
      min-height: 80px;
      font-family: inherit;
    }
    
    .modal-buttons {
      margin-top: 30px;
      display: flex;
      gap: 15px;
      justify-content: flex-end;
    }
    
    .alert {
      padding: 12px 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      border-left: 4px solid;
    }
    
    .alert-success {
      background: #d4edda;
      color: #155724;
      border-left-color: #28a745;
    }
    
    .alert-error {
      background: #f8d7da;
      color: #721c24;
      border-left-color: #dc3545;
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }
      
      .controls {
        flex-direction: column;
        align-items: stretch;
      }
      
      .search-box {
        min-width: auto;
      }
      
      .data-table {
        font-size: 12px;
      }
      
      .data-table th,
      .data-table td {
        padding: 8px 6px;
      }
      
      .action-buttons {
        flex-direction: column;
      }
      
      .modal-content {
        padding: 20px;
        width: 95%;
      }
      
      .modal-buttons {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="header">
      <h1>ğŸ“Š ãƒ‡ãƒ¼ã‚¿æ¤œç´¢ <span class="version-badge">ver.20250911_181423</span></h1>
      <p>ãƒ‡ãƒ¼ã‚¿ã®æ¤œç´¢ã¨ç·¨é›†ï¼ˆä¸‹éƒ¨ã«çµæœè¡¨ç¤ºï¼‰</p>
    </div>
    
    <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
    <div class="controls">
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="ğŸ” ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œç´¢...">
        <span class="search-icon">ğŸ”</span>
      </div>
      <a class="btn btn-primary" href="?page=reception">ğŸ“ æ–°è¦å—ä»˜</a>
      <a class="btn btn-secondary" href="?page=form_builder">ğŸ§© ãƒ•ã‚©ãƒ¼ãƒ ãƒ“ãƒ«ãƒ€ãƒ¼</a>
      <button class="btn btn-secondary" onclick="loadData()">
        ğŸ”„ æ›´æ–°
      </button>
      <button class="btn btn-secondary" onclick="showSpreadsheetInfo()">
        ğŸ“Š ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæƒ…å ±
      </button>
      <button class="btn btn-secondary" onclick="testServerConnection()">
        ğŸ”§ ã‚µãƒ¼ãƒãƒ¼ç–é€šãƒ†ã‚¹ãƒˆ
      </button>
    </div>
    
    <!-- ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div class="data-container">
      <div class="data-header">
        <div class="data-title">ğŸ“‹ ãƒ‡ãƒ¼ã‚¿ä¸€è¦§</div>
        <div class="data-count" id="dataCount">-</div>
      </div>
      
      <div id="dataContent">
        <div class="loading">
          <div class="spinner"></div>
          <div>ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
      </div>
    </div>
  </div>
  <div style="text-align:center; margin-top:12px; color:#666; font-size:12px;">
    ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ver.20250911_181423
  </div>
  
  <!-- ãƒ‡ãƒ¼ã‚¿ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <h3 id="modalTitle">ğŸ“ ãƒ‡ãƒ¼ã‚¿ç·¨é›†</h3>
      <div id="alertArea"></div>
      
      <form id="dataForm">
        <input type="hidden" id="editRowIndex" value="">
        
        
        
        <div class="modal-buttons">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">
            âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«
          </button>
          <button type="button" class="btn btn-primary" onclick="saveData()">
            ğŸ’¾ ä¿å­˜
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let allData = [];
    let filteredData = [];
    
    // åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', function() {
      loadData();
      
      // æ¤œç´¢æ©Ÿèƒ½
      document.getElementById('searchInput').addEventListener('input', function() {
        filterData(this.value);
      });
    });
    
    // ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
    function loadData() {
      showLoading();
      
      // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†ï¼ˆ30ç§’ï¼‰
      const timeoutId = setTimeout(() => {
        showAlert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'error');
        showEmptyState('ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼');
      }, 30000);
      
      google.script.run
        .withSuccessHandler((data) => {
          clearTimeout(timeoutId);
          onDataLoaded(data);
        })
        .withFailureHandler((error) => {
          clearTimeout(timeoutId);
          onLoadError(error);
        })
        .listReceptionIndex();
    }
    
    // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿æˆåŠŸæ™‚
    function onDataLoaded(data) {
      console.log('Reception data loaded:', data);
      console.log('Data type:', typeof data, 'Is array:', Array.isArray(data));
      
      // ãƒ‡ãƒ¼ã‚¿ã®æ¤œè¨¼
      if (!data || !Array.isArray(data)) {
        console.error('Invalid data format received:', data);
        showAlert('ç„¡åŠ¹ãªãƒ‡ãƒ¼ã‚¿å½¢å¼ã‚’å—ä¿¡ã—ã¾ã—ãŸ', 'error');
        showEmptyState('ãƒ‡ãƒ¼ã‚¿å½¢å¼ã‚¨ãƒ©ãƒ¼');
        return;
      }
      
      allData = data;
      filteredData = data;
      renderData();
      updateDataCount();
    }
    
    // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼æ™‚
    function onLoadError(error) {
      console.error('Load error details:', error);
      
      let errorMessage = 'ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ';
      if (error && error.message) {
        errorMessage += ': ' + error.message;
      } else if (typeof error === 'string') {
        errorMessage += ': ' + error;
      }
      
      showAlert(errorMessage, 'error');
      
      // ãƒ‡ãƒãƒƒã‚°ç”¨ã®ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
      const debugButton = '<button class="btn btn-secondary" onclick="loadDebugInfo()">ğŸ”§ ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¡¨ç¤º</button>';
      
      document.getElementById('dataContent').innerHTML = `
        <div class="empty-state">
          <div class="icon">âŒ</div>
          <h3>ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h3>
          <p>ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</p>
          <div style="margin-top: 20px;">
            ${debugButton}
          </div>
        </div>
      `;
    }
    
    // ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    function renderData() {
      const contentDiv = document.getElementById('dataContent');
      
      // filteredDataã®å­˜åœ¨ç¢ºèª
      if (!filteredData || !Array.isArray(filteredData)) {
        console.error('filteredData is not valid:', filteredData);
        showEmptyState('ãƒ‡ãƒ¼ã‚¿ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
        return;
      }
      
      if (filteredData.length === 0) {
        showEmptyState();
        return;
      }
      
      let html = `
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>ğŸ†” ID</th>
                <th>ğŸ“… å—ä»˜æ—¥</th>
                <th>ğŸ¯ å¯¾è±¡</th>
                <th>ğŸ‘¤ æ‹…å½“</th>
                <th>ğŸ“ åŒº</th>
                <th>â˜ å•ã„åˆã‚ã›</th>
                <th>ğŸ“š ç›¸è«‡ç¨®é¡</th>
                <th>ğŸ›  å¯¾å¿œç¨®é¡</th>
                <th>ğŸ“ ç›¸è«‡è©³ç´°</th>
                <th>ğŸ“… ä½œæˆ</th>
                <th>ğŸ”„ æ›´æ–°</th>
                <th>âš™ï¸ æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
      `;
      
      filteredData.forEach((row, index) => {
        // rowã®å­˜åœ¨ç¢ºèª
        if (!row || !Array.isArray(row)) {
          console.warn('Invalid row data at index', index, ':', row);
          return;
        }
        
        const originalIndex = allData.indexOf(row);
        
        // å„ã‚»ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ã‚’å®‰å…¨ã«å‡¦ç†
        const id = escapeHtml(row[0] || '');
        const date = escapeHtml(row[1] || '');
        const target = escapeHtml(row[2] || '');
        const assignee = escapeHtml(row[3] || '');
        const ward = escapeHtml(row[4] || '');
        const contact = escapeHtml(row[5] || '');
        const consultTypes = escapeHtml(row[6] || '');
        const responseTypes = escapeHtml(row[7] || '');
        const details = escapeHtml(row[8] || '');
        const createdAt = formatDateTime(row[9]);
        const updatedAt = formatDateTime(row[10]);

        html += `
          <tr>
            <td><strong>${id}</strong></td>
            <td>${date}</td>
            <td>${target}</td>
            <td>${assignee}</td>
            <td>${ward}</td>
            <td>${contact}</td>
            <td>${consultTypes}</td>
            <td>${responseTypes}</td>
            <td>${details}</td>
            <td>${createdAt}</td>
            <td>${updatedAt}</td>
            <td>
              <div class="action-buttons">
                <button class="btn btn-primary btn-sm" onclick="openReception('${id}')">
                  âœï¸ ç·¨é›†
                </button>
              </div>
            </td>
          </tr>
        `;
      });
      
      html += `
            </tbody>
          </table>
        </div>
      `;
      
      contentDiv.innerHTML = html;
    }
    
    // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹ï¼ˆkey = å†…éƒ¨åã€value = å¤–éƒ¨åã®é…åˆ—ï¼‰
    const DEFAULT_FIELD_ALIASES = {
      id: ['id','ID','ğŸ†”'],
      date: ['å—ä»˜æ—¥','date','å—ä»˜æ—¥æ™‚'],
      target: ['å¯¾è±¡','ç›¸è«‡å¯¾è±¡','target'],
      assignee: ['æ‹…å½“','assignee'],
      ward: ['åŒº','ward'],
      contact: ['å•ã„åˆã‚ã›','å•ã„åˆã‚ã›æ–¹æ³•','contact'],
      consult: ['ç›¸è«‡ç¨®é¡','consultationTypes','ç›¸è«‡'],
      response: ['å¯¾å¿œç¨®é¡','responseTypes','å¯¾å¿œ'],
      details: ['ç›¸è«‡è©³ç´°','details','è©³ç´°'],
      created: ['createdAt', 'ä½œæˆæ—¥æ™‚', 'ä½œæˆæ—¥', 'created'],
      updated: ['updatedAt', 'æ›´æ–°æ—¥æ™‚', 'æ›´æ–°æ—¥'],
    };

    // æ—¥æ™‚æ¯”è¼ƒå¯¾è±¡ï¼ˆæ­£è¦åŒ–å¾Œã®ã‚«ãƒãƒ‹ã‚«ãƒ«åï¼‰
    const DATE_FIELD_CANONICALS = new Set(['date','created', 'updated']);

    // é…åˆ—å½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’é€£æƒ³é…åˆ—å½¢å¼ã«å¤‰æ›
    function convertRowToObject(row) {
      return {
        id: row[0],
        date: row[1] || '',
        target: row[2] || '',
        assignee: row[3] || '',
        ward: row[4] || '',
        contact: row[5] || '',
        consult: row[6] || '',
        response: row[7] || '',
        details: row[8] || '',
        created: row[9] || '',
        updated: row[10] || ''
      };
    }

    function openReception(id){
      window.location.href = '?page=reception&id=' + encodeURIComponent(id);
    }

    // é«˜åº¦æ¤œç´¢æ©Ÿèƒ½ï¼ˆcolumn-regex-filter.js ã‹ã‚‰ç§»æ¤ï¼‰
    function compileQuery(input, opts) {
      opts = opts || {};
      var defaultFlags = opts.defaultFlags || 'i';
      var normalize = opts.normalize !== false;

      if (!input || typeof input !== 'string') {
        return { clauses: [] };
      }

      var text = normalize ? normalizeText(input) : input;
      var clauses = parseQuery(text);

      clauses.forEach(function(clause) {
        clause.conditions.forEach(function(cond) {
          if (cond.type === 'regex' && cond.pattern) {
            try {
              var flags = cond.flags || defaultFlags;
              cond.compiledRegex = new RegExp(cond.pattern, flags);
            } catch (e) {
              console.warn('Invalid regex pattern:', cond.pattern, e.message);
              cond.compiledRegex = null;
            }
          }
        });
      });

      return { clauses: clauses };
    }

    function parseQuery(text) {
      var orParts = text.split(/\s+OR\s+/);
      return orParts.map(function(part) {
        var conditions = [];
        var tokens = tokenize(part);
        
        tokens.forEach(function(token) {
          if (token.field) {
            var field = normalizeFieldName(token.field);
            if (field) {
              conditions.push({
                type: token.isRegex ? 'regex' : (DATE_FIELD_CANONICALS.has(field) ? 'date' : 'text'),
                field: field,
                pattern: token.value,
                operator: token.operator || '=',
                flags: token.flags,
                originalValue: token.value
              });
            }
          } else {
            conditions.push({
              type: token.isRegex ? 'regex' : 'global',
              pattern: token.value,
              flags: token.flags
            });
          }
        });
        
        return { conditions: conditions };
      });
    }

    function tokenize(text) {
      var tokens = [];
      var regex = /(\w+):(>=|<=|>|<|=)?(?:\/(.+?)\/([gimuy]*)|"([^"]*)"|(\S+))|(?:\/(.+?)\/([gimuy]*)|"([^"]*)"|(\S+))/g;
      var match;

      while ((match = regex.exec(text)) !== null) {
        if (match[1]) {
          var field = match[1];
          var operator = match[2] || '=';
          var regexPattern = match[3];
          var regexFlags = match[4];
          var quotedValue = match[5];
          var plainValue = match[6];
          
          tokens.push({
            field: field,
            operator: operator,
            value: regexPattern || quotedValue || plainValue || '',
            isRegex: !!regexPattern,
            flags: regexFlags
          });
        } else {
          var globalRegexPattern = match[7];
          var globalRegexFlags = match[8];
          var globalQuotedValue = match[9];
          var globalPlainValue = match[10];
          
          tokens.push({
            value: globalRegexPattern || globalQuotedValue || globalPlainValue || '',
            isRegex: !!globalRegexPattern,
            flags: globalRegexFlags
          });
        }
      }

      return tokens;
    }

    function normalizeFieldName(fieldName) {
      var lower = fieldName.toLowerCase();
      for (var canonical in DEFAULT_FIELD_ALIASES) {
        var aliases = DEFAULT_FIELD_ALIASES[canonical];
        for (var i = 0; i < aliases.length; i++) {
          if (aliases[i].toLowerCase() === lower) {
            return canonical;
          }
        }
      }
      return null;
    }

    function normalizeText(text) {
      return text.normalize('NFKC');
    }

    function filterRows(rows, compiled, opts) {
      opts = opts || {};
      
      if (!compiled.clauses || compiled.clauses.length === 0) {
        return rows;
      }

      return rows.filter(function(row) {
        var obj = convertRowToObject(row);
        return compiled.clauses.some(function(clause) {
          return clause.conditions.every(function(cond) {
            return matchCondition(obj, cond);
          });
        });
      });
    }

    function matchCondition(obj, cond) {
      if (cond.type === 'global') {
        return Object.values(obj).some(function(value) {
          if (value == null) return false;
          var str = String(value);
          if (cond.compiledRegex) {
            return cond.compiledRegex.test(str);
          } else {
            return str.toLowerCase().includes(cond.pattern.toLowerCase());
          }
        });
      }

      var fieldValue = obj[cond.field];
      if (fieldValue == null) return false;

      if (cond.type === 'date') {
        return compareDates(fieldValue, cond.pattern, cond.operator);
      }

      var str = String(fieldValue);
      if (cond.compiledRegex) {
        return cond.compiledRegex.test(str);
      } else {
        return str.toLowerCase().includes(cond.pattern.toLowerCase());
      }
    }

    function compareDates(fieldValue, pattern, operator) {
      try {
        var fieldDate = new Date(fieldValue);
        var patternDate = new Date(pattern);
        
        if (isNaN(fieldDate.getTime()) || isNaN(patternDate.getTime())) {
          return false;
        }

        switch (operator) {
          case '>=': return fieldDate >= patternDate;
          case '<=': return fieldDate <= patternDate;
          case '>': return fieldDate > patternDate;
          case '<': return fieldDate < patternDate;
          case '=':
          default: return fieldDate.getTime() === patternDate.getTime();
        }
      } catch (e) {
        return false;
      }
    }

    // æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆé«˜åº¦æ¤œç´¢å¯¾å¿œç‰ˆï¼‰
    function filterData(searchTerm) {
      if (!searchTerm.trim()) {
        filteredData = allData;
      } else {
        const compiled = compileQuery(searchTerm, { defaultFlags: 'i', normalize: true });
        filteredData = filterRows(allData, compiled);
      }
      renderData();
      updateDataCount();
    }
    
    // ãƒ‡ãƒ¼ã‚¿ä»¶æ•°ã‚’æ›´æ–°
    function updateDataCount() {
      const countElement = document.getElementById('dataCount');
      countElement.textContent = `${filteredData.length} / ${allData.length} ä»¶`;
    }
    
    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
    function showLoading() {
      document.getElementById('dataContent').innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <div>ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
      `;
    }
    
    // ç©ºçŠ¶æ…‹è¡¨ç¤º
    function showEmptyState(message = 'ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“') {
      document.getElementById('dataContent').innerHTML = `
        <div class="empty-state">
          <div class="icon">ğŸ“‚</div>
          <h3>${message}</h3>
          <p>ã€Œæ–°è¦è¿½åŠ ã€ãƒœã‚¿ãƒ³ã‹ã‚‰æœ€åˆã®ãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„</p>
        </div>
      `;
    }
    
    // æ–°è¦è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    function showAddModal() {
      document.getElementById('modalTitle').textContent = 'â• æ–°è¦ãƒ‡ãƒ¼ã‚¿è¿½åŠ ';
      document.getElementById('editRowIndex').value = '';
      resetForm();
      showModal();
    }
    
    // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    function showEditModal(index) {
      const data = allData[index];
      document.getElementById('modalTitle').textContent = 'âœï¸ ãƒ‡ãƒ¼ã‚¿ç·¨é›†';
      document.getElementById('editRowIndex').value = index;
      
      // ãƒ‡ãƒ¼ã‚¿ä»¥å¤–ã®ç·¨é›†ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯å»ƒæ­¢ã—ã¾ã—ãŸ
      
      showModal();
    }
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    function showModal() {
      document.getElementById('editModal').classList.add('show');
      clearAlert();
    }
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    function closeModal() {
      document.getElementById('editModal').classList.remove('show');
    }
    
    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
    function resetForm() {
      document.getElementById('dataForm').reset();
    }
    
    // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
    function saveData() {
      // ã“ã®ç”»é¢ã§ã®ç·¨é›†ã¯ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™ï¼ˆãƒ‡ãƒ¼ã‚¿å°‚ç”¨ã¸ç§»è¡Œï¼‰
      showAlert('ã“ã®ç”»é¢ã§ã®ç·¨é›†ã¯ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™ï¼ˆãƒ‡ãƒ¼ã‚¿ã‚’ã”åˆ©ç”¨ãã ã•ã„ï¼‰', 'error');
      return;
      
      // Set loading state
      setLoadingState(true);
      
      // Collect form dataï¼ˆç„¡åŠ¹åŒ–ï¼‰
      const formData = {};
      
      const rowIndex = document.getElementById('editRowIndex').value;
      
      console.log('Starting save:', formData, 'rowIndex:', rowIndex);
      
      // Set timeout (30 seconds)
      const timeoutId = setTimeout(() => {
        setLoadingState(false);
        showAlert('å‡¦ç†ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚', 'error');
      }, 30000);
      
      if (rowIndex === '') {
        // Add new data
        console.log('Adding new data...');
        google.script.run
          .withSuccessHandler((result) => {
            clearTimeout(timeoutId);
            onSaveSuccess(result);
          })
          .withFailureHandler((error) => {
            clearTimeout(timeoutId);
            onSaveError(error);
          })
          .addNewData(formData);
      } else {
        // Update existing data
        console.log('Updating data...');
        google.script.run
          .withSuccessHandler((result) => {
            clearTimeout(timeoutId);
            onSaveSuccess(result);
          })
          .withFailureHandler((error) => {
            clearTimeout(timeoutId);
            onSaveError(error);
          })
          .updateData(formData, parseInt(rowIndex) + 2);
      }
    }
    
    // Manage loading state
    function setLoadingState(isLoading) {
      const saveBtn = document.querySelector('.modal-buttons .btn-primary');
      const modalContent = document.querySelector('.modal-content');
      
      if (isLoading) {
        saveBtn.innerHTML = 'ğŸ’¾ ä¿å­˜ä¸­...';
        saveBtn.disabled = true;
        modalContent.style.opacity = '0.7';
        modalContent.style.pointerEvents = 'none';
      } else {
        saveBtn.innerHTML = 'ğŸ’¾ ä¿å­˜';
        saveBtn.disabled = false;
        modalContent.style.opacity = '1';
        modalContent.style.pointerEvents = 'auto';
      }
    }
    
    // Save success handler
    function onSaveSuccess(message) {
      console.log('Save success:', message);
      setLoadingState(false);
      showAlert(message, 'success');
      setTimeout(() => {
        closeModal();
        loadData();
      }, 1500);
    }
    
    // Save error handler
    function onSaveError(error) {
      console.error('Save error:', error);
      setLoadingState(false);
      showAlert('ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + (error.message || error), 'error');
    }
    
    // å‰Šé™¤ç¢ºèª
    function confirmDelete(index) {
      const data = allData[index];
      const label = `è¡Œ ${index+1}`;
      if (confirm(`ã€Œ${label}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) {
        google.script.run
          .withSuccessHandler(onDeleteSuccess)
          .withFailureHandler(onDeleteError)
          .deleteData(index + 2); // ãƒ˜ãƒƒãƒ€ãƒ¼åˆ†+1ã€0ãƒ™ãƒ¼ã‚¹èª¿æ•´+1
      }
    }
    
    // å‰Šé™¤æˆåŠŸæ™‚
    function onDeleteSuccess(message) {
      showAlert(message, 'success');
      loadData();
    }
    
    // å‰Šé™¤ã‚¨ãƒ©ãƒ¼æ™‚
    function onDeleteError(error) {
      showAlert('å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
    }
    
    // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’èª­ã¿è¾¼ã¿
    function loadDebugInfo() {
      showLoading();
      
      google.script.run
        .withSuccessHandler((debugInfo) => {
          console.log('Debug info:', debugInfo);
          
          const formattedInfo = `
            <div class="debug-info" style="text-align: left; font-family: monospace; font-size: 12px; background: #f5f5f5; padding: 15px; border-radius: 5px; margin: 10px; white-space: pre-wrap;">
              ${JSON.stringify(debugInfo, null, 2)}
            </div>
          `;
          
          document.getElementById('dataContent').innerHTML = `
            <div class="empty-state">
              <div class="icon">ğŸ”§</div>
              <h3>ãƒ‡ãƒãƒƒã‚°æƒ…å ±</h3>
              ${formattedInfo}
              <div style="margin-top: 20px;">
                <button class="btn btn-secondary" onclick="loadData()">ğŸ”„ å†è©¦è¡Œ</button>
              </div>
            </div>
          `;
        })
        .withFailureHandler((error) => {
          console.error('Debug info error:', error);
          showAlert('ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.message || error), 'error');
        })
        .debugGetAllData();
    }
    
    // ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
    function showAlert(message, type) {
      const alertArea = document.getElementById('alertArea') || document.createElement('div');
      
      if (!document.getElementById('alertArea')) {
        alertArea.id = 'alertArea';
        document.querySelector('.container').insertBefore(alertArea, document.querySelector('.data-container'));
      }
      
      const className = type === 'success' ? 'alert-success' : 'alert-error';
      alertArea.innerHTML = `<div class="alert ${className}">${message}</div>`;
      
      if (type === 'error') {
        setTimeout(clearAlert, 15000);
      }
    }
    
    // ã‚¢ãƒ©ãƒ¼ãƒˆã‚¯ãƒªã‚¢
    function clearAlert() {
      document.getElementById('alertArea').innerHTML = '';
    }
    
    // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
    function escapeHtml(text) {
      // null, undefined, æ•°å€¤ãªã©ã‚’æ–‡å­—åˆ—ã«å¤‰æ›
      if (text === null || text === undefined) {
        return '';
      }
      
      // æ•°å€¤ã‚„ãã®ä»–ã®ã‚¿ã‚¤ãƒ—ã‚’æ–‡å­—åˆ—ã«å¤‰æ›
      const textStr = String(text);
      
      const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      };
      return textStr.replace(/[&<>"']/g, function(m) { return map[m]; });
    }
    
    // æ—¥æ™‚ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    function formatDateTime(dateValue) {
      if (!dateValue) return '';
      
      try {
        const date = new Date(dateValue);
        if (isNaN(date.getTime())) return '';
        
        return date.toLocaleString('ja-JP', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        });
      } catch (e) {
        return '';
      }
    }
    
    // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæƒ…å ±ã‚’è¡¨ç¤º
    function showSpreadsheetInfo() {
      google.script.run
        .withSuccessHandler((info) => {
          let infoHtml = '<h3>ğŸ“Š ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæƒ…å ±</h3>';
          
          if (info.spreadsheetInfo && info.spreadsheetInfo.id) {
            infoHtml += `
              <div style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <p><strong>ID:</strong> ${info.spreadsheetInfo.id}</p>
                <p><strong>åå‰:</strong> ${info.spreadsheetInfo.name}</p>
                <p><strong>URL:</strong> <a href="${info.spreadsheetInfo.url}" target="_blank">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é–‹ã</a></p>
                <p><strong>ã‚·ãƒ¼ãƒˆä¸€è¦§:</strong> ${info.spreadsheetInfo.sheets.join(', ')}</p>
              </div>
            `;
          } else {
            infoHtml += '<p>ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚</p>';
          }
          
          // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ä½œæˆã—ã¦è¡¨ç¤º
          const modal = document.createElement('div');
          modal.className = 'modal show';
          modal.innerHTML = `
            <div class="modal-content">
              ${infoHtml}
              <div class="modal-buttons">
                <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">
                  âŒ é–‰ã˜ã‚‹
                </button>
              </div>
            </div>
          `;
          
          // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
          modal.addEventListener('click', function(e) {
            if (e.target === modal) {
              modal.remove();
            }
          });
          
          document.body.appendChild(modal);
        })
        .withFailureHandler((error) => {
          showAlert('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.message || error), 'error');
        })
        .debugSpreadsheetInfo();
    }
    
    // ã‚µãƒ¼ãƒãƒ¼ç–é€šãƒ†ã‚¹ãƒˆ
    function testServerConnection() {
      console.log('=== CLIENT: Testing server connection ===');
      
      // ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ†ã‚¹ãƒˆ
      google.script.run
        .withSuccessHandler((result) => {
          console.log('=== CLIENT: Simple test success ===', result);
          showAlert('ã‚·ãƒ³ãƒ—ãƒ«ãƒ†ã‚¹ãƒˆæˆåŠŸ: ' + result, 'success');
          
          // pingãƒ†ã‚¹ãƒˆ
          google.script.run
            .withSuccessHandler((pingResult) => {
              console.log('=== CLIENT: Ping test success ===', pingResult);
              showAlert('Pingãƒ†ã‚¹ãƒˆæˆåŠŸ: ' + JSON.stringify(pingResult), 'success');
              
              // getAllDataSafeãƒ†ã‚¹ãƒˆ
              google.script.run
                .withSuccessHandler((dataResult) => {
                  console.log('=== CLIENT: getAllDataSafe test success ===', dataResult);
                  showAlert('ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ†ã‚¹ãƒˆçµæœ: ' + (dataResult ? 'ãƒ‡ãƒ¼ã‚¿ã‚ã‚Š' : 'null'), dataResult ? 'success' : 'error');
                  
                  // è©³ç´°ãƒ‡ãƒãƒƒã‚°ãƒ†ã‚¹ãƒˆ
                  google.script.run
                    .withSuccessHandler((debugResult) => {
                      console.log('=== CLIENT: Debug step test success ===', debugResult);
                      showAlert('è©³ç´°ãƒ‡ãƒãƒƒã‚°çµæœ: ' + debugResult, 'success');
                    })
                    .withFailureHandler((error) => {
                      console.error('=== CLIENT: Debug step test failed ===', error);
                      showAlert('è©³ç´°ãƒ‡ãƒãƒƒã‚°å¤±æ•—: ' + (error.message || error), 'error');
                    })
                    .debugGetAllDataStep();
                })
                .withFailureHandler((error) => {
                  console.error('=== CLIENT: getAllDataSafe test failed ===', error);
                  showAlert('ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ†ã‚¹ãƒˆå¤±æ•—: ' + (error.message || error), 'error');
                })
                .getAllDataSafe();
            })
            .withFailureHandler((error) => {
              console.error('=== CLIENT: Ping test failed ===', error);
              showAlert('Pingãƒ†ã‚¹ãƒˆå¤±æ•—: ' + (error.message || error), 'error');
            })
            .pingTest();
        })
        .withFailureHandler((error) => {
          console.error('=== CLIENT: Simple test failed ===', error);
          showAlert('ã‚·ãƒ³ãƒ—ãƒ«ãƒ†ã‚¹ãƒˆå¤±æ•—: ' + (error.message || error), 'error');
        })
        .simpleTest();
    }
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    document.getElementById('editModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeModal();
      }
    });
  </script>
</body>
</html>


